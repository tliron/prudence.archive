<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="http://www.nongnu.org/elyxer/">
<meta name="create-date" content="2010-05-24">
<link rel="stylesheet" href="http://www.nongnu.org/elyxer/lyx.css" type="text/css" media="screen">
<title>Prudence Manual</title>
</head>
<body>
<div id="globalWrapper">

<h1 class="title">
The Prudence Manual
</h1>
<h2 class="author">
Copyright 2009-2010 by Three Crickets LLC<br>
Main text written by Tal Liron
</h2>
<div class="Unindented">
Permission is granted to copy, distribute and/or modify this document under the terms of the <a class="URL" href="http://www.gnu.org/licenses/fdl.html">GNU Free Documentation License</a>, Version 1.3 or any later version published by the Free Software Foundation; with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts. A copy of the license is included in the file license.txt.
<span class="Newpage">

</span>
</div>
<div class="Indented">

<div class="fulltoc">

<div class="tocheader">
Table of Contents
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Section-1">Section: Tutorial</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-1">Subsection: Run the Prudence Instance</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-2">Subsection: Your First Application</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-3">Subsection: A Static Web Page</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-4">Subsection: A Dynamic Web Page</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-5">Subsection: A Resource</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-6">Subsection: Advanced Routing</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-7">Subsection: Other Features</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-2">Section: Instance Configuration</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-8">Subsection: Configuration by Script</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-9">Subsection: /defaults/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-10">Subsection: /applications/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-11">Subsection: /instance/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-12">Subsection: /bin/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-13">Subsection: /logs/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-14">Subsection: /configuration/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-15">Subsection: /libraries/</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-3">Section: Application Configuration</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-16">Subsection: /web/dynamic/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-17">Subsection: /web/static/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-18">Subsection: /web/fragments/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-19">Subsection: /resources/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-20">Subsection: /libraries/</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-21">Subsection: Configuration Scripts</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-22">Subsection: Settings</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-4">Section: Generating HTML</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-23">Subsection: Files</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-24">Subsection: Scriptlets</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-25">Subsection: Mixing Languages</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-26">Subsection: Includes</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-27">Subsection: Life</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-28">Subsection: Caching</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-29">Subsection: Streaming</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-30">Subsection: HTML forms</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-31">Subsection: Mapping and Changing MIME Types</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-5">Section: Resources </a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-32">Subsection: Life</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-33">Subsection: CRUD</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-34">Subsection: Implied Representation</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-35">Subsection: Error Codes</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-36">Subsection: Explicit Representation</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-37">Subsection: Conditional HTTP</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-38">Subsection: Concurrency Concerns</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-39">Subsection: Mixing Languages</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-40">Subsection: Accessing Resources Internally</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-41">Subsection: Accessing External REST Services</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-42">Subsection: Representations</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-6">Section: Static Web</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-43">Subsection: Mapping MIME Types</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-44">Subsection: Replacing Grizzly</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-45">Subsection: CacheControlFilter </a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-46">Subsection: JavaScriptUnifyMinifyFilter </a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-47">Subsection: CssUnifyMinifyFilter</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-7">Section: Routing</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-48">Subsection: Directories As URL Segments</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-49">Subsection: default.*</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-50">Subsection: URI Templates</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-51">Subsection: Virtual Hosts</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-52">Subsection: Attaching</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-53">Subsection: Redirecting</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-54">Subsection: Capturing</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-55">Subsection: Capturing Errors</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-8">Section: API</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-56">Subsection: application</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-57">Subsection: document</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-58">Subsection: executable</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-59">Subsection: conversation</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-60">Subsection: Managing State</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-9">Section: Debugging</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Section-10">Section: Logging</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-61">Subsection: Sending Messages</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-62">Subsection: logging.conf</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-63">Subsection: web.log</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-11">Section: Administration</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Section-12">Section: Prudence As a Daemon</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-64">Subsection: YAJSW</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-65">Subsection: Monitoring via JMX</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-66">Subsection: JSW</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-13">Section: HTTP Proxy</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-67">Subsection: Perlbal</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-68">Subsection: Apache</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-14">Section: Prudence As a Restlet Container</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-69">Subsection: Summary</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-70">Subsection: Custom Resources</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-71">Subsection: Custom Application</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-15">Section: How to Choose a Flavor?</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-72">Subsection: Python (Succulent!)</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-73">Subsection: Ruby (Delectable!)</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-74">Subsection: Clojure (Scrumptious!)</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-75">Subsection: JavaScript (Savory!)</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-76">Subsection: PHP (Ambrosial!)</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-77">Subsection: Groovy (Luscious!)</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-16">Section: The Case for REST</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-78">Subsection: Resources</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-79">Subsection: Identifiers</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-80">Subsection: Delete</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-81">Subsection: Read</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-82">Subsection: Update</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-83">Subsection: Create</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-84">Subsection: Aggregate Resources</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-85">Subsection: Formats</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-86">Subsection: Shared State</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-87">Subsection: Summary of Features</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-88">Subsection: Let’s Do It!</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-89">Subsection: The Punchline</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-90">Subsection: It’s All About Infrastructure</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-91">Subsection: Does REST Scale?</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-92">Subsection: Prudence</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-17">Section: Scaling Tips</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-93">Subsection: Caching</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-94">Subsection: Necessary Tasks</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-95">Subsection: Deferrable Tasks</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-96">Subsection: Uploads</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-97">Subsection: Asynchronous Processing</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-98">Subsection: Data Backends</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-99">Subsection: Graph Databases</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-100">Subsection: Document Databases</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-101">Subsection: Best of All Worlds</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-102">Subsection: Powering Up</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-103">Subsection: Partitioning</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-104">Subsection: Coding Tips</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-18">Section: Under the Hood</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-105">Subsection: Restlet</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-106">Subsection: The JVM</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-107">Subsection: Jython, JRuby, Clojure, Rhino, Quercus, Groovy</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-108">Subsection: Scripturian</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-109">Subsection: Succinct</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-110">Subsection: Jygments</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-111">Subsection: H2</a>
</div></div>

<div class="toc">
<a class="Link" href="#toc-Section-19">Section: FAQ</a>
</div><div class="tocindent">

<div class="toc">
<a class="Link" href="#toc-Subsection-112">Subsection: REST</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-113">Subsection: Languages</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-114">Subsection: Concurrency</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-115">Subsection: Performance</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-116">Subsection: Scalability</a>
</div>
<div class="toc">
<a class="Link" href="#toc-Subsection-117">Subsection: Licensing</a>
</div></div>
</div>

</div>
<span class="Newpage">

</span>
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-1"></a>Tutorial
</h1>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-1"></a>Run the Prudence Instance
</h2>
<div class="Unindented">
Prudence comes ready to rumble!
</div>
<div class="Indented">
All you need is a Java Virtual Machine (JVM), minimally version 5. Your operating system may already have one. Typing ‘‘java’’ from the command line will usually tell you so. Otherwise, an excellent, open-source JVM is available from the <a class="URL" href="http://openjdk.java.net/">OpenJDK</a> project.
</div>
<blockquote class="Quote">
A Java Runtime Environment (JRE) is enough for Prudence. You need a Java Development Kit (JDK) only if you plan to write code in Java. Also, Prudence does not require anything from Java Enterprise Edition (JEE). In fact, you can see Prudence as a RESTful, minimal alternative to developing web applications under JEE.
</blockquote>
<div class="Unindented">
Try Prudence! Run /bin/run.sh for Unix-like systems (Linux and OS X), or /bin/run.bat for Windows. Prudence should declare its version list the installed demo applications. When it announces that it is listening on port 8080, it’s ready to go. Open your web browser to <a class="URL" href="http://localhost:8080/">http://localhost:8080/</a>. You should see the Prudence Administration application, where you can access the demos. 
</div>
<blockquote class="Quote">
<i>By the way:</i> The /bin/run scripts are there for getting you quickly up and running, however it is strongly recommended that you run <a class="URL" href="../daemon/">Prudence as a daemon</a> in production environments.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-2"></a>Your First Application
</h2>
<div class="Unindented">
Your Prudence instance hosts all applications under the /applications/ directory. To install a new application, simply create a new subdirectory there. The subdirectory name will be used as a default for various things: the base URL, logging, etc. We can change those later. 
</div>
<div class="Indented">
So, let’s create /applications/wackywiki/
</div>
<div class="Indented">
If you restart Prudence, you’ll see wackywiki listed in the admin application. There’s nothing to see there quite yet, though.
</div>
<blockquote class="Quote">
<i>By the way:</i> It’s perfectly fine to use symbolic links or mounts to put your application subdirectories elsewhere.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-3"></a>A Static Web Page
</h2>
<div class="Unindented">
Create /applications/wackywiki/web/static/. Files you put there will served just like from any static web server. You can put images, HTML files, CSS or anything else. Let’s start with a default web page.
</div>
<div class="Indented">
/web/static/index.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;html&gt;
&lt;head&gt;
	&lt;title&gt;Wacky Wiki&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div&gt;
		Nothing to see here, for now. Carry on.
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt; 
</code>
</div>
</div>
</div>
<div class="Indented">
Restart Prudence, and browse to <a class="URL" href=" http://localhost:8080/wackiwiki/">http://localhost:8080/wackiwiki/</a> to see the page. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-4"></a>A Dynamic Web Page
</h2>
<blockquote class="Quote">
Important! While Prudence does dynamic web pages well, it really stands out from other web frameworks in its support for REST resources, which we’ll see in the next section. We decided to start this tutorial with web pages, because the topic would likely be more familiar to most newcomers to Prudence.
</blockquote>
<div class="Unindented">
Create /applications/wackywiki/web/dynamic/. Unlike /web/static/, files in this directory must be text files (HTML, XML, plain text, etc.) They are specially processed so that they can include ‘‘scriptlets’’ of programming code. 
</div>
<div class="Indented">
Let’s move our index.html from /web/static/ to /web/dynamic/ and edit it to add some Python scriptlets. 
</div>
<div class="Indented">
/web/dynamic/index.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;html&gt;
&lt;head&gt;
	&lt;title&gt;Wacky Wiki&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div&gt;
		It is currently
&lt;%python
from datetime import datetime
now = datetime.now()
print now.strftime(’%H:%M’)
%&gt;
		o’ clock, and
&lt;%
print now.strftime(’%S’)
%&gt;
		seconds
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</div>
</div>
</div>
<div class="Indented">
Restart Prudence, and browse to <a class="URL" href=" http://localhost:8080/wackiwiki/">http://localhost:8080/wackiwiki/</a> to see the page. 
</div>
<div class="Indented">
You’ll notice the &lt;% and %&gt; are used to delimit scriptlets, and that we’ve added ‘‘python’’ to the opening delimiter of the first scriptlet. Subsequent scriptlets on the page will automatically use the language of the previous scriptlets, so we don’t have to repeat ‘‘python’’.
</div>
<div class="Indented">
Note, too, that Python’s ‘‘print’’ works by adding output to the stream of text where the scriptlet is located.
</div>
<div class="Indented">
Final note: Though they are conventionally called ‘‘scriptlets,’’ they are not ‘‘scripts’’ in the common meaning of interpreted code. All scriptlets are, in fact, compiled and run as JVM bytecode. That’s fast.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-1"></a>Expressions
</h3>
<div class="Unindented">
Let’s make our dynamic page more readable by using special ‘‘expression scriptlets.’’ They’re really just a shorthand for ‘‘print.’’
</div>
<div class="Indented">
/web/dynamic/index.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;html&gt;
&lt;head&gt;
	&lt;title&gt;Wacky Wiki&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div&gt;
&lt;%python
from datetime import datetime
now = datetime.now()
%&gt;
		It is currently &lt;%= now.strftime(’%H:%M’) %&gt; o’ clock, and &lt;%= now.strftime(’%S’) %&gt; seconds
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</div>
</div>
</div>
<div class="Indented">
What happens if you have a coding error in your scriptlets? Let’s try and introduce an error on purpose.
</div>
<div class="Indented">
/web/dynamic/index.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">... from dratetime import datetime ...
</code>
</div>
</div>
</div>
<div class="Indented">
If you try to browse to the page, Prudence will show you a detailed debug page, from where you can also access the source code with the troublesome code line highlighted. Once you deploy your application, you can cancel this debug feature. Also, you can show your own, custom, user-friendly error pages. We’ll get to that below. 
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-2"></a>Fragments
</h3>
<div class="Unindented">
Prudence lets you include others documents in-place using a special scriptlet. This makes it very easy to reuse fragments of documents (which can include scriptlets) throughout your dynamic pages. Common reusbale fragments are page headers, footers, and navigation menus.
</div>
<div class="Indented">
By convention in Prudence, fragments are put in /web/fragments/, though you can include them from anywhere, even from your regular /web/dynamic/ or /web/static/ subdirectories. The advantage of keeping them out of those subdiretories is that users won’t be able to access the individual fragments directly. Instead, we must explicitly include them in our /web/dynamic/ files. 
</div>
<div class="Indented">
Let’s create a fragment that displays the current time.
</div>
<div class="Indented">
/web/fragments/time.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;%python
from datetime import datetime
now = datetime.now()
%&gt;
It is currently &lt;%= now.strftime(’%H:%M’) %&gt; o’ clock, and &lt;%= now.strftime(’%S’) %&gt; seconds
</code>
</div>
</div>
</div>
<div class="Indented">
/web/dynamic/index.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;html&gt;
&lt;head&gt;
	&lt;title&gt;Wacky Wiki&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div&gt;
		&lt;%&amp; ’time/’ %&gt;
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</div>
</div>
</div>
<div class="Indented">
Note that the included scriptlet, which begins with the &lt;%&amp; delimiter, accepts a real Python expression. For example, you can do Pythony things like string interpolation: &lt;%&amp; ’%s-%s’ % (language, encoding) %&gt;, allowing you to include different fragments according to changing circumstances. 
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-3"></a>Caching
</h3>
<div class="Unindented">
Dynamically generating HTML and other text is very powerful. You may be wondering, however, how well this scales. Even if the Python code is compiled, it would still need to be run for every user request, right? Prudence supports straightforward per-page caching to greatly help you scale. By changing document.cacheDuration within a scriptlet, you can dynamically change how long Prudence will look for updates in the document. Note that even very short caching times can be a great boost to scalability. For example, if your cache duration is 1 second, it means that your scriptlets would only be run once every second. In computing terms, that’s a very long time! Imagine that your popular web site is getting 1000 hits per second... 
</div>
<div class="Indented">
Finally, you’ll be happy to know that by default Prudence also enables client-side caching. It does this by setting a standard HTTP header that tells the client how long the content should be cached. All popular desktop and mobile web browsers recognize it. This means bandwidth savings for you, because the client will not download content it already has in its cache. 
</div>
<div class="Indented">
Let’s enable a simple 60 second cache.
</div>
<div class="Indented">
/web/dynamic/index.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;% document.cacheDuration = 60000 %&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;title&gt;Wacky Wiki&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div&gt;
		&lt;%&amp; ’time/’ %&gt;
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</div>
</div>
</div>
<div class="Indented">
To test the above, go to our page and keep refreshing it in your web browser. You will see that the printed time will only be updated once every 10 seconds.
</div>
<div class="Indented">
To verify that client-side caching works correctly, we recommend using the free Firefox browser with the <a class="URL" href="http://getfirebug.com/">Firebug</a> add-on. In the Firebug network panel, you can see which requests are sent to the server. Within those 60 seconds between updates, you will see the that the request for the page returns a 304 status code: ‘‘the document has not been modified.’’
</div>
<div class="Indented">
For an even more elaborate experiment, try running two browsers at the same time on different machines, and keep refreshing them. You’ll see each client caching individually, and yet the server still returning a different page only after the 60 second cache duration has passed. 
</div>
<div class="Indented">
Caching is very powerful, but obviously not useful for all pages. For example, if it’s important for a page to always show the up-to-date to the moment information, you might not be able to afford even a one second cache. It’s useful, then, to know that Prudence’s document.cacheDuration works at the level of the actual document, so that each included fragment can set its own cache duration. Just remember that the top document or fragment requests will determine the caching for included fragments, too. If your index.html has a cache duration of 60 seconds, then even if an included fragment has a cache duration of 1 second, it would only appear to update every 60 seconds. 
</div>
<div class="Indented">
Scriptlets can also dynamically change the cache duration according to changing circumstances. For example, under heavy load, you might want your application to cache for longer periods of time.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-4"></a>HTML Forms
</h3>
<div class="Unindented">
TODO
</div>
<div class="Indented">
Let’s allow users to edit our wacky wicki. 
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">form = prudence.resource.request.resourceRef.queryAsForm
fresh = form.getFirstValue(’fresh’) == ’true’
</code>
</div>
</div>
</div>
<div class="Indented">
/web/fragments/wiki.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;%python
wiki = ’Nothing in the wiki yet.’
%&gt;
Wiki content is: &lt;%= wiki %&gt;
</code>
</div>
</div>
</div>
<div class="Indented">
/web/dynamic/index.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;html&gt;
&lt;head&gt;
	&lt;title&gt;Wacky Wiki&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div&gt;
		&lt;%&amp; ’time/’ %&gt;
	&lt;/div&gt;
	&lt;div&gt;
		&lt;%&amp; ’wiki/’ %&gt;
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code>
</div>
</div>
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-5"></a>More HTTP
</h3>
<div class="Unindented">
Prudence does a lot of the HTTP work automatically, but you can manipulate the response yourself. For example, to redirect the client: 
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">prudence.resource.response.locationRef = prudence.resource.request.resourceRef.baseRef
prudence.statusCode = 303
raise
</code>
</div>
</div>
</div>
<blockquote class="Quote">
Note the use of ‘‘raise’’: it’s a handy trick to end processing of our page. Prudence recognizes that we explicitly changed the status code, so it doesn’t consider this to be a real error.
</blockquote>
<div class="Unindented">
You can use also prudence.statusCode to explicitly set an error, for example to send 403 (‘‘Forbidden’’) if the user is not logged in. 
</div>
<div class="Indented">
Need more HTTP? Prudence supports HTTP cookies and HTTP authentication challenges. We won’t get into that in this tutorial, though. 
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-6"></a>Templating
</h3>
<div class="Unindented">
You might wonder what other options are available to you other than ‘‘python’’ for scriptlets. You can choose other languages---Ruby, JavaScript, Clojure, PHP, etc.---if you have them installed. But, more importantly, you can choose to use one of the pre-included templating languages, Succint and Velocity.
</div>
<div class="Indented">
Templating languages have far less features than any of the above programming languages, but this can be an advantage if you all you need is simple templating. They tend to be more readable for templates. Best of all, you can mix scriptlets from various languages in one page. Here’s an example of using Velocity and Python: 
</div>
<div class="Indented">
/web/fragments/time.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;%python
from datetime import datetime
now = datetime.now()
clock = now.strftime(’%H:%M’)
seconds = now.strftime(’%S’)
%&gt;
&lt;%velocity It is currently $clock o’ clock, and $seconds seconds %&gt;
</code>
</div>
</div>
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-5"></a>A Resource
</h2>
<div class="Unindented">
As stated earlier, where Prudence truly shines is in its support for REST resources. A resource is a piece of data associated with a URL, which clients can optionally create, read, update or delete. An HTML web page is an example of a resource which is usually read, and sometimes supports writing (for handling HTML forms). Prudence lets you create resources that support one or more formats, all create/read/update/delete (CRUD) operations, and advanced caching. 
</div>
<div class="Indented">
A resource-oriented architecture is perfect for ‘‘AJAX’’ and other rich client platforms (Flash, Silverlight, etc.). Another use is for a scalable backend conduit between servers. Depending on how you look at it, resources are either an online database, an API for your service, or both. 
</div>
<blockquote class="Quote">
You might want to take a look at <a class="URL" href="../rest/">Making the Case for REST</a> for a better understanding of REST and what it can do for you.
</blockquote>
<div class="Unindented">
Let’s start with a resource that can be read for some plain text. Resources are put in the /resources/ subdirectory, and, like /web/dynamic/ and /web/static/, the filename and directory tree define the URL:
</div>
<div class="Indented">
/resources/wiki.py:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">def handle_init(conversation):
	conversation.addMediaTypeByName(’text/plain’)
def handle_get(conversation):
	return ’Nothing in the wiki yet.’
</code>
</div>
</div>
</div>
<div class="Indented">
handleInit() always gets called first, before any of the other handler functions. 
</div>
<div class="Indented">
Try browsing to <a class="URL" href=" http://localhost:8080/wackiwiki/wiki/">http://localhost:8080/wackiwiki/wiki/</a> to see your resource.
</div>
<div class="Indented">
Plain text is good for us humans to read. But, we might want to support formats that are more useful for client applications, such as <a class="URL" href="http://www.json.org/">JSON</a> for browser-based JavaScript or Flash’s ActiveScript. 
</div>
<div class="Indented">
Let’s add support for JSON to our resource:
</div>
<div class="Indented">
/resources/wiki.py:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">wiki = ’Nothing in the wiki yet.’
​
def handle_init(conversation):
	conversation.addMediaTypeByName(’text/plain’)
	conversation.addMediaTypeByName(’application/json’)
​
def handle_get(conversation):
	if conversation.mediaTypeByName == ’text/plain’:
		return wiki
	else:
		return ’{"content": "%s"}’ % wiki
</code>
</div>
</div>
</div>
<div class="Indented">
[Add jQuery to dynamic page to test in browser.]
</div>
<div class="Indented">
Just as /web/fragments/ was a useful place for us to put reusable web fragments, we can use /libraries/ for reusable code for resources, as well as dynamic web scriptlets. Let’s create a library to handle our wiki:
</div>
<div class="Indented">
/libraries/wiki.py:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">wiki = ’Nothing in the wiki yet.’
​
def get_wiki():
	return wikiwiki = ’Nothing in the wiki yet.’
​
def handle_init(conversation):
	conversation.addMediaTypeByName(’text/plain’)
	conversation.addMediaTypeByName(’application/json’)
​
def handle_get(conversation):
	if conversation.mediaTypeByName == ’text/plain’:
		return wiki
	else:
		return ’{"content": "%s"}’ % wiki
</code>
</div>
</div>
</div>
<div class="Indented">
Let’s make use of our library in our resource: 
</div>
<div class="Indented">
/resources/wiki.py:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">from wiki import get_wiki
​
def handle_init(conversation):
	conversation.addMediaTypeByName(’text/plain’)
	conversation.addMediaTypeByName(’application/json’)
​
def handle_get(conversation):
	if conversation.mediaTypeByName == ’text/plain’:
		return get_wiki()
	else:
		return ’{"content": "%s"}’ % get_wiki()
</code>
</div>
</div>
</div>
<div class="Indented">
[Put, Post, Delete.]
</div>
<div class="Indented">
/libraries/wiki.py:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">from threading import RLock
​
wiki = ’Nothing in the wiki yet.’
wiki_lock = RLock()
​
def get_wiki():
	wiki_lock.acquire()
	try:
		return wiki
	finally:
		wiki_lock.release()
​
def set_wiki(content):
	wiki_lock.acquire()
	try:
		wiki = content
	finally:
		wiki_lock.release()
</code>
</div>
</div>[Fixing our form handling from earlier using doPost.]
</div>
<div class="Indented">
Remember how we supported client-side caching for our dynamic web pages? We have much more control over this process in resources. We can set explicit modification dates and ETags. 
</div>
<div class="Indented">
Let’s give our wiki resources a modification date, so that clients can properly cache it:
</div>
<div class="Indented">
/libraries/wiki.py:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">from threading import RLock
from datetime import datetime
​
def to_milliseconds(dt):
	return long(mktime(dt.timetuple()) * 1000)
	wiki = {content: ’Nothing in the wiki yet.’, timestamp: datetime.now()}
	wiki_lock = RLock()
​
def get_wiki():
	wiki_lock.acquire()
	try:
		# Note that we are returning a copy of our wiki dictionary!
		return {content: wiki[’content’], timestamp: wiki[’timestamp’]}
	finally:
		wiki_lock.release()
​
def set_wiki(content):
	wiki_lock.acquire()
	try:
		wiki[’content’] = content
		wiki[’timestamp’] = datetime.now()
	finally:
		wiki_lock.release()
</code>
</div>
</div>
</div>
<div class="Indented">
/resources/wiki.py:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">from wiki import get_wiki, set_wiki, to_milliseconds
​
def handle_init(conversation):
	conversation.addMediaTypeByName(’text/plain’)
	conversation.addMediaTypeByName(’application/json’)
​
def handle_get(conversation):
	wiki = get_wiki()
	conversation.modificationTimestamp = to_milliseconds(wiki[’timestamp’])
	if conversation.mediaTypeByName == ’text/plain’:
		return wiki[’content’]
	else:
		return ’{"content": "%s"}’ % wiki[’content’]
</code>
</div>
</div>
</div>
<div class="Indented">
Support for modification date can go a long way towards saving us bandwidth. However, note that we still have to fetch the entire wiki in order to get its modification date. This could potentially be a costly operation, say, if the wiki is stored in a database. 
</div>
<div class="Indented">
Prudence lets you optimize this by letting you check only the modification date (or ETag) before actually fetching the resource. 
</div>
<div class="Indented">
Let’s add handleGetInfo():
</div>
<div class="Indented">
/resources/wiki.py:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">from wiki import get_wiki, set_wiki, to_milliseconds
​
def handle_init(conversation):
	conversation.addMediaTypeByName(’text/plain’)
	conversation.addMediaTypeByName(’application/json’)
​
def handle_get(conversation):
	wiki = get_wiki()
	conversation.modificationTimestamp = to_milliseconds(wiki[’timestamp’])
	if conversation.mediaTypeByName == ’text/plain’:
		return wiki[’content’]
	else:
		return ’{"content": "%s"}’ % wiki[’content’]
​
def handle_get_info(conversation):
	wiki = get_wiki()
	return to_milliseconds(wiki[’timestamp’])
</code>
</div>
</div>
</div>
<div class="Indented">
Our trivial example didn’t offer any significant savings. But, suppose our resource involved fetching lots of wiki pages at once? We could save computing power if you we only had to fetch a modification date. 
</div>
<div class="Indented">
As we said earlier, our resources can be seen as an API. Indeed, there’s no reason to maintain two sets of APIs, one for ‘‘the world’’ to access via your resources, and one for your application to use internally. You can use easily use your resources internally: 
</div>
<div class="Indented">
/fragments/wiki.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;%python
wiki = document.internal(’wiki’, ’application/json’)
wiki = eval(’(’ + wiki.text + ’)’)
%&gt;
Wiki content is: &lt;%= wiki[’content’] %&gt;
</code>
</div>
</div>
</div>
<div class="Indented">
The above is wasteful because we are turning the wiki data into JSON and then back again. For internal API uses, it’s possible to support direct access to the object: 
</div>
<div class="Indented">
[ObjectRepresentation]
</div>
<div class="Indented">
For completion, here’s an example of how to access our resources from another Prudence-based application:
</div>
<div class="Indented">
/fragments/wiki.html:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">&lt;%python
wiki = document.external(’http://192.168.1.2/wackywiki/wiki’, ’application/json’)
wiki = eval(’(’ + wiki.text + ’)’)
%&gt;
Wiki content is: &lt;%= wiki[’content’] %&gt;
</code>
</div>
</div>
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-6"></a>Advanced Routing
</h2>
<div class="Unindented">
Capturing URL patterns.
</div>
<div class="Indented">
Improve our resource above over the query params.
</div>
<blockquote class="Quote">
<i>By the way:</i> Difference between URL and URI.
</blockquote>
<div class="Unindented">
Virtual hosting, multiple servers.
</div>
<div class="Indented">
Status handlers---custom 404.
</div>
<div class="Indented">
Just for fun: robots.txt, sitemap.xml.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-7"></a>Other Features
</h2>
<div class="Unindented">
Logging.
</div>
<div class="Indented">
Debug page.
</div>
<div class="Indented">
Defrosting and pre-heating.
</div>
<div class="Indented">
SSL. http://www.restlet.org/documentation/snapshot/jse/ext/index.html?org/restlet/ext/grizzly/HttpsServerHelper.html
</div>
<div class="Indented">
Advanced representations. (Restlet extensions.)
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-2"></a>Instance Configuration
</h1>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-8"></a>Configuration by Script
</h2>
<div class="Unindented">
Most instance and application configuration files are written in programming language code, rather than XML or other configuration formats. This method is sometimes called ‘‘boot-strapping’’ or just ‘‘scripting.’’
</div>
<div class="Indented">
Scripting is powerful. It lets your configuration be dynamic, such that the same configuration script can do different things depending on the actual deployment environment and runtime circumstances. For example, you can deploy the same instance to a development environment, where it will start various debugging processes and logs, and a production environment, where it will optimize for performance and scale. You can even have different optimizations for different deployments. For example, a weak cloud-based instance with a single virtual CPU might be different from a dedicated box with 8 cores and a lot of RAM. You can dynamically test for the presence of installed optional components, etc.
</div>
<div class="Indented">
The disadvantage is portability between Prudence flavors. For example, if you write your scripts in Ruby, they will not work in Prudence for Python---<i>unless</i> you manually install Python support.
</div>
<div class="Indented">
The default scripts are designed to fall back on other default scripts, which are all in the /defaults/ subdirectory. The common way to override any default script is to create your own version, execute the default script first, and then apply your overrides. You can also <i>not </i>execute the default script, and instead handle things your own way. Or, you can edit the defaults directly to apply changes across the board.
</div>
<blockquote class="Quote">
For changes in your configuration scripts to take effect, you will need to restart the Prudence instance. This is true for Prudence 1.0: we planto support runtime configuration in a future version of Prudence.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-9"></a>/defaults/
</h2>
<div class="Unindented">
Here you’ll find defaults used in /instance/ and /applications/. Generally, you’ll not want to edit these, but instead override them there. Prudence tries to make configuration easy by using sensible default behavior, and making it easy to override it. However, you can always edit these files directly if necessary.
</div>
<div class="Indented">
Rather than explain their use here, we will refer to them as they are used in the sections below.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-10"></a>/applications/
</h2>
<div class="Unindented">
This is where you deploy your applications, each occupying a subdirectory. Your application’s subdirectory name serves as a useful default name for your application. It is also the default base URL, and the default logging name. You can change any of these default easily.
</div>
<div class="Indented">
More about configuring applications <a class="URL" href="../application-structure/">here</a>.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-11"></a>/instance/
</h2>
<div class="Unindented">
This is where the Prudence instance gets initialized. The instance is the overall container which manages the servers and the applications.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-7"></a>/instance/default.*
</h3>
<div class="Unindented">
This is the only required instance configuration script. It simply executes /defaults/instance/.
</div>
<div class="Indented">
You’ll usually prefer to override the other configuration files below. Override default.* if you want to do things after everything else in the instance has been initialized.
</div>
<div class="Indented">
The default script does the following:
</div>
<ol>

<li>
Prints the Prudence welcome message
</li>
<li>
Sets up logging, including applying /configuration/logging.conf
</li>
<li>
Executes /instance/component/ or /defaults/instance/component/
</li>
<li>
Executes /instance/clients/ or /defaults/instance/clients/
</li>
<li>
Executes /instance/routing/ or /defaults/instance/routing/
</li>
<li>
Executes /instance/servers/ or /defaults/instance/servers/
</li>
<li>
Starts the component
</li>
<li>
Submits tasks for execution
</li>
</ol>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-8"></a>/instance/component.*
</h3>
<div class="Unindented">
The ‘‘component’’ in REST terminology refers to the highest-level communication abstraction. In essence, its all ‘‘components’’ communicating with other ‘‘components.’’ Every Prudence instance is in essence a single component, which can include multiple servers and clients.
</div>
<div class="Indented">
Override this script to change the way the component is created. In particular you might want to change the default cache backend or executor from the defaults.
</div>
<div class="Indented">
The default script does the following:
</div>
<ol>

<li>
Creates a Restlet component
</li>
<li>
Configures its logService
</li>
<li>
Sets its statusService to be a DelegatedStatusService
</li>
<li>
Creates a global, fixed-thread-pool executor (accessible as ‘‘prudence.executor’’ in the component’s context)
</li>
<li>
Creates an InProcessMemory cache backend (accessible as ‘‘com.threecrickets.prudence.cache’’ in the component’s context)
</li>
</ol>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-9"></a>/instance/clients.*
</h3>
<div class="Unindented">
Override this script to add more clients to your component.
</div>
<div class="Indented">
The default script adds file and HTTP clients.
</div>
<div class="Indented">
The file client is required for static web support, and also for you to access files on your filesystem as REST resources.
</div>
<div class="Indented">
The HTTP client is required for you to access external REST resources on the web.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-10"></a>/instance/routing.*
</h3>
<div class="Unindented">
Override this script to change the way the component initializes its routing. Because this script delegates to /instance/hosts/ and to individual application, it’s unlikely that you’ll need to override the default behavior.
</div>
<div class="Indented">
The default script does the following:
</div>
<ol>

<li>
Executes /instance/hosts/ or /defaults/instances/hosts/
</li>
<li>
Initializes all applications in /applications/ (this list is accessible as ‘‘applications’’ in the component’s context)
</li>
<li>
If there are no applications, Prudence quits
</li>
</ol>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-11"></a>/instance/hosts.*
</h3>
<div class="Unindented">
Virtual hosting allows you to serve multiple web sites from a single component. You can configure individual applications to attach one or more hosts, and to have different base URLs on each of these hosts. Prudence allows you to create virtual hosts for multiple domain names and HTTP ports, using simple expressions and wildcards. (Note that actually creating a server to listen on additional ports is a separate matter, dealt with in /instances/servers/*, below.)
</div>
<div class="Indented">
By default, an ‘‘allHosts’’ virtual host is created, and set as the component’s default host, which in turn all applications attach to by default. ‘‘allHosts’’ accepts all incoming requests, to any domain name, to any port.
</div>
<div class="Indented">
Override this script to create additional virtual hosts for your component, and to change the default host.
</div>
<div class="Indented">
For example, you might want your Prudence component to only serve requests for ‘‘www.mysite.org’’ instead of the permissive ‘‘allHosts.’’ Or, you might want to serve multiple web sites with different sets of applications on each.
</div>
<div class="Indented">
The default script does the following:
</div>
<ol>

<li>
Creates the ‘‘allHosts’’ virtual host
</li>
<li>
Sets it as the component’s default host
</li>
</ol>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-12"></a>/instance/servers.*
</h3>
<div class="Unindented">
Servers do the low-level work of listening to a port, accepting requests, and returning responses according to supported protocols. Prudence currently supports various HTTP servers: <a class="URL" href="https://grizzly.dev.java.net/">Grizzly</a>, <a class="URL" href="http://jetty.codehaus.org/jetty/">Jetty</a>, <a class="URL" href="http://www.jboss.org/netty">Netty</a> and an ‘‘internal’’ connector. (To change the HTTP server technology, you have to add it to /libraries/.)
</div>
<div class="Indented">
You can create as many servers as you need to listen on multiple ports. Remember that routing is actually handled by virtual hosts, not the servers. So, if you have servers on ports 8081, 8082, and 8083, and your applications all attach to ‘‘allHosts,’’ then the applications will be available on all ports. To limit applications to specific ports, you will need to create additional virtual hosts.
</div>
<div class="Indented">
Override this script to change the default port (8080) or add additional servers on other ports.
</div>
<div class="Indented">
The default script does the following:
</div>
<ol>

<li>
Creates an HTTP server on port 8080, with support for the X-FORWARDED-FOR used by proxies
</li>
<li>
Prints out information about this server
</li>
</ol>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-12"></a>/bin/
</h2>
<div class="Unindented">
Use run.sh for Unix-like operating systems, such as Linux, *BSD and Mac OS X, and run.bat for Windows.
</div>
<div class="Indented">
In production environments, it’s best to run Prudence as a daemon in Unix-like systems or a service in Windows, via a lightweight wrapper. See <a class="URL" href="../daemon/">Prudence As a Daemon</a>.
</div>
<div class="Indented">
What the /bin/ scripts do is:
</div>
<ol>

<li>
Set the JVM classpath to include all the JARs in /libraries/
</li>
<li>
Start the JVM
</li>
<li>
Delegate to your /instance/ script
</li>
</ol>
<blockquote class="Quote">
Note that if you’re using JVM version 6 or above, you can use wildcards for specifying the classpath in run.sh and run.bat, instead of having to list individual JAR files.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-13"></a>/logs/
</h2>
<div class="Unindented">
This is where your rolling logs will appear. Prudence logs are highly configurable and powerful. In particular, your web.log will show all requests hitting your Prudence server, using a standard format that can be consumes and analyzed by software.
</div>
<div class="Indented">
More on logging <a class="URL" href="../logging/">here</a>.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-14"></a>/configuration/
</h2>
<div class="Unindented">
There are a few essential configuration files here. Most important is <a class="URL" href="../logging/">logging.conf</a>, but you will also find some optional files to help you configure Prudence to run as a daemon.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-15"></a>/libraries/
</h2>
<div class="Unindented">
Here you will find Prudence’s main libraries as well as support libraries. The main subdirectory is for Java archives (JARs), but you may find subdirectories for libraries in other languages, such as Python.
</div>
<div class="Indented">
If you add your own JARs, make sure to edit the scripts in /bin/ to accommodate your additions.
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-3"></a>Application Configuration
</h1>
<div class="Unindented">
Each application’s subdirectory name under the /applications/ directory is used as a default for many things. Under that subdirectory is a straightforward structure, detailed below.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-16"></a>/web/dynamic/
</h2>
<div class="Unindented">
This is where you’ll put your dynamic HTML files. By ‘‘dynamic’’ is meant that they are generated on-demand, such that each request can potentially produce a different result. Prudence has a powerful framework for embedding programming language code into HTML as ‘‘scriptlets,’’ with support for caching, as well as textual formats other than HTML, such as XML, RSS, JSON, etc. See <a class="URL" href="../generating-html/">generating HTML</a>.
</div>
<div class="Indented">
The names of the files and subdirectories under /web/dynamic/ attach to URLs, with simple intelligence to make it easy for you to create sensible, pretty URL schemes.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-17"></a>/web/static/
</h2>
<div class="Unindented">
This subdirectory works like a standard ‘‘static’’ web server. Files put here are attached to URLs and accessible to clients as is. Prudence uses non-blocking I/O for high performance, scalable delivery of data to client.
</div>
<div class="Indented">
Like many web servers, MIME types for HTTP headers are automatically assigned according to the filename extension. For example. ‘‘.html’’ files will be sent as ‘‘application/html’’, and ‘‘.png’’ files will be sent as ‘‘image/png’’.
</div>
<div class="Indented">
The static web subdirectory will likely just work for you as is. See <a class="URL" href="../static-web/">static web</a> for details on configuring it, for example, in order to add/change filename-extension-to-MIME-type mappings.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-18"></a>/web/fragments/
</h2>
<div class="Unindented">
Your dynamic pages in /web/dynamic/ can include any page fragments from here. The advantage of putting them here rather than there is that here they will not be attached to URLs and be available to users.
</div>
<div class="Indented">
Fragments allow you to compose complex pages out of basic building blocks. Another import use is for fine-grained caching: each fragment has its own caching behavior. See <a class="URL" href="../generating-html/">generating HTML</a>.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-19"></a>/resources/
</h2>
<div class="Unindented">
Whereas the /web/dynamic/ subdirectory has HTML files with embedded programming language code, /resources/ is pure code. This is Prudence’s most flexible development feature: files here are attached as REST resources, capable of handling all HTTP verbs and responding with appropriate representations in many different formats.
</div>
<div class="Indented">
From the perspective of web development, consider that if /web/dynamic/ lets you write HTML-based front ends for ‘‘thin’’ clients, such as simple web browsers, /resources/ lets you handle ‘‘rich’’ clients, such as AJAX, Flash and other dynamic platforms.
</div>
<div class="Indented">
See<a class="URL" href="../resources/">resources</a>.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-20"></a>/libraries/
</h2>
<div class="Unindented">
All your code, whether its in /resources/ or scriptlets in /web/dynamic/ and /fragments/, can include code from /libraries/.
</div>
<div class="Indented">
Use whatever mechanism is appropriate for your language: ‘‘import’’ for Python or Ruby, ‘‘use’’ for Clojure, etc. For languages that don’t have inclusion mechanisms---Groovy, JavaScript---you can use Prudence’s inclusion mechanism, document.execute.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-21"></a>Configuration Scripts
</h2>
<div class="Unindented">
The application’s configuration scripts are in its base subdirectory. See <a class="URL" href="../instance/">instance configuration</a> for more details about configuration scripts.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-13"></a>/default.*
</h3>
<div class="Unindented">
You’ll rarely need to do it, but you can also override Prudence’s default application bootstrap.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-14"></a>/settings.*
</h3>
<div class="Unindented">
Here you can override some of Prudence’s defaults for your application, such as the subdirectory structure detailed here, the default URLs, include some distribution information, configure the logging name, etc.
</div>
<div class="Indented">
You can also add your own runtime settings for your code to use, such as database usernames and passwords.
</div>
<div class="Indented">
See Settings, below, for full detail on overrides and default settings.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-15"></a>/routing.*
</h3>
<div class="Unindented">
The settings file gives you some control over the default URLs, but here you can manipulate them extensively. Your routing tools are very powerful, including redirection based on URL patterns, regular expressions, and route scoring.
</div>
<div class="Indented">
In particular, this is where you install URL patterns for your resources. For example, you can attach /item/{id}/ to your item resource, and have ‘‘id’’ automatically extracted from the URL.
</div>
<div class="Indented">
This is also where you can attach your own custom (non-Prudence) resources to URLs. Actually, anything that’s a ‘‘restlet’’ will do, because Prudence uses <a class="URL" href="http://restlet.org/">Restlet</a> for its resource routing. More on integrating custom restlets <a class="URL" href="../restlet-container/">here</a>.
</div>
<div class="Indented">
More on <a class="URL" href="../routing/">routing</a> later.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-16"></a>/application.*
</h3>
<div class="Unindented">
Use this to install non-Prudence Restlet applications into Prudence. By default, Prudence creates a basic Restlet application, but you can override that creation in this file. More on this topic <a class="URL" href="../restlet-container/">here</a>.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-22"></a>Settings
</h2>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-17"></a>Information
</h3>
<div class="Unindented">
These are for administrative purposes only.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-1"></a>applicationName
</div>
<div class="Unindented">
Defaults to the application’s subdirectory name
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-2"></a>applicationDescription
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-3"></a>applicationAuthor
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-4"></a>applicationOwner
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-5"></a>applicationHomeURL
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-6"></a>applicationContactEmail
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-18"></a>Debugging
</h3>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-7"></a>showDebugOnError
</div>
<div class="Unindented">
Set to true to show debug information on error
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-8"></a>showSourceCodeURL
</div>
<div class="Unindented">
The base URL for showing source code (only relevant when showDebugOnError is true)
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-19"></a>Logging
</h3>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-9"></a>applicationLoggerName
</div>
<div class="Unindented">
Defaults to the application’s subdirectory name
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-20"></a>Hosts
</h3>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-10"></a>hosts
</div>
<div class="Unindented">
This is a vector of vectors of two elements: the first is the virtual host to which our application will be attached, the second is the base URLs on the hosts. Specify null for the URL to default to the application’s directory name.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-21"></a>Resources
</h3>
<div class="Unindented">
Sets up a directory under which you can place script files that implement RESTful resources. The directory structure underneath the base directory is directly linked to the base URL. 
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-22"></a>resourcesBaseURL
</h3>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-11"></a>resourcesBasePath
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-12"></a>resourcesDefaultName
</div>
<div class="Unindented">
If the URL points to a directory rather than a file, and that directory contains a file with this name, then it will be used. This allows you to use the directory structure to create nice URLs without relying on filenames.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-13"></a>resourcesDefrost
</div>
<div class="Unindented">
Set this to true if you want to start to load and compile your resources as soon as Prudence starts.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-14"></a>resourcesSourceViewable
</div>
<div class="Unindented">
This is so we can see the source code for scripts by adding ?source=true to the URL. You probably wouldn’t want this for most applications.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-15"></a>resourcesMinimumTimeBetweenValidityChecks
</div>
<div class="Unindented">
This is the time (in milliseconds) allowed to pass until a script file is tested to see if it was changed. During development, you’d want this to be low, but during production, it should be high in order to avoid unnecessary hits on the filesystem.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-23"></a>Dynamic Web
</h3>
<div class="Unindented">
Sets up a directory under which you can place text files that support embedded scriptlets. Note that the generated result can be cached for better performance.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-16"></a>dynamicWebBaseURL
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-17"></a>dynamicWebBasePath
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-18"></a>dynamicWebDefaultDocument
</div>
<div class="Unindented">
If the URL points to a directory rather than a file, and that directory contains a file with this name, then it will be used. This allows you to use the directory structure to create nice URLs that do not contain filenames.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-19"></a>dynamicWebDefrost
</div>
<div class="Unindented">
Set this to true if you want to compile your scriptlets as soon as Prudence starts.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-20"></a>dynamicWebPreheat
</div>
<div class="Unindented">
Set this to true if you want to load all your dynamic web documents as soon as Prudence starts.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-21"></a>dynamicWebSourceViewable
</div>
<div class="Unindented">
This is so we can see the source code for scripts by adding ?source=true to the URL. You probably wouldn’t want this for most applications.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-22"></a>dynamicWebMinimumTimeBetweenValidityChecks
</div>
<div class="Unindented">
This is the time (in milliseconds) allowed to pass until a script file is tested to see if it was changed. During development, you’d want this to be low, but during production, it should be high in order to avoid unnecessary hits on the filesystem.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-24"></a>Static Web
</h3>
<div class="Unindented">
Sets up a directory under which you can place static files of any type. // Servers like Grizzly and Jetty can use non-blocking I/O to stream static files efficiently to clients.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-23"></a>staticWebBaseURL
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-24"></a>staticWebBasePath
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-25"></a>staticWebDirectoryListingAllowed
</div>
<div class="Unindented">
If the URL points to a directory rather than a file, then this will allow automatic creation of an HTML page with a directory listing.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-25"></a>Preheater
</h3>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-26"></a>preheatResources
</div>
<div class="Unindented">
List resources here that you want heated up as soon as Prudence starts.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-26"></a>URL Manipulation
</h3>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-27"></a>urlAddTrailingSlash
</div>
<div class="Unindented">
The URLs in this array will automatically be redirected to have a trailing slash added to them if it’s missing.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-27"></a>Runtime Attributes
</h3>
<div class="Unindented">
runtimeAttributes
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-4"></a>Generating HTML
</h1>
<div class="Unindented">
Prudence has good support for generating HTML by allowing you to embed programming language code in it. Despite some unique and useful features, Prudence is not so much different in this than other platforms that support dynamic HTML generation. Where Prudence stands out is in its support for REST resources, which we’ll deal with in <a class="URL" href="../resources/">the next section</a>. Go ahead and skip to there if HTML generation bores you!
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-23"></a>Files
</h2>
<div class="Unindented">
Files under /web/dynamic/ are all assumed to be text files. While we’re titling this section ‘‘Generating HTML,’’ these files can, in fact, be in any textual format. The filename’s extension will be used to map the default MIME type for the file, though you can easily change it in code.
</div>
<blockquote class="Quote">
Create a file named index.html under /web/dynamic/. Open your web browser to http://localhost:8080/hello/. You should see your file rendered in the browser. Note that you did not have to enter index.html, though it would also work. Additionally, just index would work: in the /web/dynamic/ and /resources/ subdirectories, Prudence considers filename extensions to be optional for URLs.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-24"></a>Scriptlets
</h2>
<div class="Unindented">
Programming language code can be embedded within your /web/dynamic/ files using either &lt;% %&gt; or &lt;? ?&gt;. Note, however, that you can only use one of either in the same file.
</div>
<div class="Indented">
For historical reasons, these embedded bits of code are called ‘‘scriptlets.’’ However, they are usually compiled, not interpreted.
</div>
<div class="Indented">
Blocks can span several scriptlets (as long as you are using the same programming language: see below). For example, this will work as expected:
</div>
<div class="Indented">
You can achieve the same result by printing out the text in Python code:
</div>
<div class="Indented">
In fact, behind the scenes, all non-scriptlet text is turned into code. It’s a simple print of the non-scriptlet text.
</div>
<div class="Indented">
A common idiom is to print out expressions interwoven with non-scriptlet text. The expression scriptlet, marked by an equal sign, can help you reduce clutter. For example:
</div>
<div class="Indented">
Just remember that behind the scenes the expression scriptlet is turned into a regular scriptlet, So, you need to follow all the rules of Python expressions.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-25"></a>Mixing Languages
</h2>
<div class="Unindented">
By default, Prudence will assume your scriptlets to be Python code. However, Prudence lets you scriptlets of various languages by adding the language name after the first scriptlet delimiter. For example:
</div>
<blockquote class="Quote">
You need the appropriate language JARs under your /libs/ directory for this to work.
</blockquote>
<div class="Unindented">
Once you change the language, all subsequent scriptlets will default to that language. Make sure to change back if you need to.
</div>
<div class="Indented">
You might think that mixing programming languages is a bad idea in general, and only necessary for making use of legacy code. However, it can be a great idea if you consider that Prudence comes with high-performance templating languages, both Succinct and Velocity. This lets you write all the more straightforward templating as Succinct scriptlets, switching to Python scriptlets only when you need Python features. For example:
</div>
<div class="Indented">
Not only is the Succinct code more readable and easier to manage, but it also performs betters, is less prone to errors, and more secure. Prudence lets you use the right tool for the right job.
</div>
<div class="Indented">
One tiny hiccup to be aware of is that blocks can no longer trivially span several scriptlets. For example, this won’t immediately work:
</div>
<div class="Indented">
The reason is that, by necessity, Prudence must run scriptlets of different languages separately, in sequence. The language switch thus represents a boundary, But, fear not, Prudence lets you solve this problem via the ‘‘in-flow’’ scriptlet, marked by a colon:
</div>
<div class="Indented">
This works! But how, you might wonder? Behind the scenes, the in-flow scriptlet is run from within the enclosing language. We thus do never leave the enclosing language for the purposes of running through the file. Don’t worry about performance here: in-flow scriptlets are compiled only once per file. Also, in-flow scriptlets are treated as regular scriptlets if there is no language switch.
</div>
<blockquote class="Quote">
Prudence’s terrific handling of scriptlets in multiple languages is internally handled by the Scripturian library. Scripturian was originally developed for Prudence, but its use is generic and useful enough that it merited separating it into a separate project. With Scripturian, you can easily add scriptlet power to your Java applications.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-26"></a>Includes
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-27"></a>Life
</h2>
<div class="Unindented">
As mentioned, files are only compiled once, when they are first requested by a client. From then on, each request is handled by the compiled version.
</div>
<div class="Indented">
What if you edit the file? Prudence can automatically pick up your changes and recompile. This happens on the fly, while the application is running. Are you worried that this check would happen for every client request? You can easily disable this feature for production deployments, or control the minimum time interval in which Prudence assumes the file is unchanged.
</div>
<blockquote class="Quote">
Your compiled file can be run by multiple threads concurrently. It is up to you to avoid race conditions and guarantee thread safety.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-28"></a>Caching
</h2>
<div class="Unindented">
You’ve chosen to use dynamically-generated HTML because you want request to be able to have different results. However, sometimes you do not expect results to change very often. For example, a home web page might display the local temperature, but it would probably be good enough to update it every hour, instead of per request.
</div>
<div class="Indented">
Depending on what your scriptlets are doing, dynamically generating a web page can be very costly, and could be a performance and scalability bottleneck for your application under heavy load. You don’t want to waste energy and resources to generate results that do not change.
</div>
<div class="Indented">
The solution is to cache results. Sometimes even caching for tiny time intervals can make a huge different in the ability of your application to handle load. For example, let’s say that in order to fetch the local temperature for our web page we need to query a service on the network. Without caching, every client request would result in a service query. Let’s say our web page gets 100 hits per second. Even just caching our home page for 5 seconds would throttle our service queries down to 1 every 5 seconds, vs. 500 every 5 seconds without caching. And users would get temperature readings up to 5 seconds old. It’s a negligible usability with enormous savings.
</div>
<div class="Indented">
This was a trivial example. Truly scalable software requires smart caching everywhere, from the level of file and database access all the way to the generated results.
</div>
<div class="Indented">
Prudence handles caching of results. Every file has its own caching interval, which you can access and change via scriptlet:
</div>
<div class="Indented">
Note that you can change the cache interval dynamically. For example, you might want to increase it if you see that your machine’s CPU load is too high, or you might even want to decrease it during ‘‘rush hours’’ where users expect to see especially up-to-date results.
</div>
<div class="Indented">
By using includes, you can fine-tune your caching strategy even more. Since each file has its own caching interval, you can fragment your page into parts with different caching sensitivity. For example, you can put the temperature reading in its own fragment, with a high cache interval, with another fragment being a ‘‘number of visitors today’’ counter with no cache interval, always up-to-date. The home page itself could have its own interval, or none. This setup can help you think of caching problems independently, while allowing for subtle overall schemes.
</div>
<div class="Indented">
TODO: default caching time in application context
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-29"></a>Streaming
</h2>
<div class="Unindented">
Sometimes the client expects a slow, and long response from your application. For example, a list of bank account transactions for the past year might be hundreds of rows in length. The client does not want to wait until you’ve produced the entire result, but can start consuming results as they come.
</div>
<div class="Indented">
Streaming mode lets send results to your client as you produce them.
</div>
<div class="Indented">
There are risks to streaming mode. If your scriptlet code fails along the way, the stream will stop and the client might get broken results, For example, an HTML table might not get its closing &lt;/table&gt; tag, leading to a broken rendering on a web browser. Of course, this is a general risk, and can happen due to connection failures along the way. It’s just something you need to be extra careful about in streaming mode. So, make sure you catch all exceptions and gracefully finish the request for the client in case of error.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-30"></a>HTML forms
</h2>
<div class="Unindented">
The files in /web/dynamic/ are meant to be sent to the clients, in response to an HTTP GET. Later on, we’ll look at files under /resources/, which can respond to all HTTP verbs. However, there is one case in which you might want to respond to HTTP POST and PUT directly in your /web/dynamic/ files: HTML form submissions. Though hardly ideal, HTML forms are the most universally supported technique of getting input from clients, and are easy to set up.
</div>
<div class="Indented">
Prudence’s solution is trivial: it attaches your file to HTTP POST and PUT in addition to HTTP GET. This leaves it up to you to handle each method accordingly. Here is an example:
</div>
<div class="Indented">
Handling form responses via scriplets can make your files hard to read, as they turn into a patchwork of various results all overlapped in one file. This can be cleaned up via includes:
</div>
<div class="Indented">
Still, it might make more sense to remove all this form handling logic from /web/dynamic/ to /resources/. We’ll show you an example of it in the next section.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-31"></a>Mapping and Changing MIME Types
</h2>
<div class="Unindented">
See <a class="URL" href="../static-web/">this</a>.
</div>
<div class="Indented">
By extension Programmatically (text, XML, JSON)
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-5"></a>Resources 
</h1>
<div class="Unindented">
Resources as API.
</div>
<div class="Indented">
There’s no need to maintain a separate ‘‘internal API,’’ with REST resources serving as an ‘‘external API.’’ Your resources are available internally, without having to use HTTP. A single, uniform API is more maintainable, and less prone to bugs. Additionally, the internal connectivity is an easy way to test your resources. See below for internal access to your resources.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-32"></a>Life
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-33"></a>CRUD
</h2>
<div class="Unindented">
An example of handleGet in Python:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">def handleGet():
	id = int(prudence.resource.request.attributes.get(’id’))
	session = get_session()
	try:
		note = session.query(Note).filter_by(id=id).one()
	except NoResultFound:
		return 404 finally: session.close()
	prudence.modificationTimestamp = note.timestamp
	if prudence.mediaTypeName == ’application/json’:
		return json.write(note.to_dict())
	elif if prudence.mediaTypeName == ’application/xml’:
		return dict_to_xml(note.to_dict())
	else:
		return 415
</code>
</div>
</div>
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-34"></a>Implied Representation
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-35"></a>Error Codes
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-36"></a>Explicit Representation
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-37"></a>Conditional HTTP
</h2>
<div class="Unindented">
getInfo(), modification dates and ETags
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-38"></a>Concurrency Concerns
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-39"></a>Mixing Languages
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-40"></a>Accessing Resources Internally
</h2>
<div class="Unindented">
Prudence has very easy-to-use REST client, and a rich API for creating and manipulation data <a class="URL" href="../representations/">representations</a>. You can use it to access your own resources, as well as resources from other applications in your Prudence installation. Examples:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">importClass(org.restlet.resource.ClientResource);
​
// A resource in our application
var r = new ClientResource(’riap://application/hosts’);
print(r.get().text);
​
// A resource from another application on our host
var id = 9;
var r = new ClientResource(’riap://host/stickstick/note/’ + id + ’/’);
var note = JSON.parse(String(r.get(MediaType.APPLICATION_JSON).text));
</code>
</div>
</div>
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-41"></a>Accessing External REST Services
</h2>
<div class="Unindented">
The client API mentioned above can also be used to access external resources from anywhere on the web.
</div>
<div class="Indented">
Examples:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">importClass(org.restlet.resource.ClientResource);
​
// An external resource
var r = new ClientResource(’http://threecrickets/prudence/data/rhino’);
print(r.get().text);
</code>
</div>
</div>
</div>
<div class="Indented">
Note that for the above to work, you need HTTP configured in your clients file:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">component.clients.add(Protocol.HTTP);
</code>
</div>
</div>
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-42"></a>Representations
</h2>
<div class="Unindented">
MIME Types
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-6"></a>Static Web
</h1>
<div class="Unindented">
Prudence attaches your application’s /web/static/ subdirectory to URLs, making files there available via HTTP GET. In other words, /static/web/ is a ‘‘web server.’’ It’s a convenient place for storing immutable resources that your clients will need to run your application: images, styles, scripts, etc.
</div>
<div class="Indented">
You’re likely, though, wondering if /web/static/ is merely a convenience, and if you’d be better off using Apache or other dedicated web servers instead of Prudence to serve your the static files.
</div>
<div class="Indented">
Our recommendation is to take that route only if those web servers offer important features that you won’t find in Prudence. Remember that Prudence has many powerful features, including URL redirecting, rewriting and routing, and that Prudence’s non-blocking I/O actually does a great job at serving files. You will likely not see many performance or scalability gains replacing /web/static/ with standard Apache.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-43"></a>Mapping MIME Types
</h2>
<div class="Unindented">

<div class="float">

<div class="listing">
<code class="listing">application.metadataService.addExtension(’php’, MediaType.TEXT_HTML)
</code>
</div>
</div>
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-44"></a>Replacing Grizzly
</h2>
<div class="Unindented">
Grizzly can be replaced with <a class="URL" href="http://jboss.org/netty">Netty</a>, a non-blocking I/O HTTP server with slightly different performance characteristics, and <a class="URL" href="http://www.mortbay.org/jetty/">Jetty</a>, which offers similar performance, but with many more features. Or, use any other connector supported by <a class="URL" href="http://www.restlet.org/">Restlet</a>. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-45"></a>CacheControlFilter 
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-46"></a>JavaScriptUnifyMinifyFilter 
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-47"></a>CssUnifyMinifyFilter
</h2>
<h1 class="Section">
<a class="toc" name="toc-Section-7"></a>Routing
</h1>
<div class="Unindented">
Prudence can actually run several servers at the same time, on multiple IP addresses and ports, as well as handle several web sites via virtual hosting.
</div>
<div class="Indented">
‘‘Routing’’ in Prudence refers to how URLs are attached to resources. In fact, this is often not a simple one-to-one relationship, and different routes may be selected according to changing circumstances.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-48"></a>Directories As URL Segments
</h2>
<div class="Unindented">
Prudence provides straightforward, hierarchical, live routing between your directory structure and URLs. Simply put, file paths are mapped directly to URLs. Files added at runtime will automatically create new URLs for them. To keep the URLs pretty, filename extensions are optional. The filename extension, though serves two purposes:
</div>
<div class="Indented">
In the case of code in /resources/, /libraries/ or other places, the extension selects the language engine which will run the code. For example, ‘‘search.py’’ will be run using Python, ‘‘search.gv’’ will be Groovy, ‘‘search.clj’’ will be Clojure, etc.
</div>
<div class="Indented">
In the case of files in /web/dynamic/ and /web/static/, it helps select the default MIME type for representations. This selection is based on the meta data service, which you can customize (see <a class="URL" href="../static-web/">static web</a>). Embedded language code in /web/dynamic/ files can also programatically change the returns MIME types (see <a class="URL" href="../resources/">resources</a>). 
</div>
<blockquote class="Quote">
When Prudence URLs are attached to files in /web/dynamic/ and /resources/, the filename extension is optional. Prudence simply grabs the first file it finds with that name. So, generally, get used to not have more than one file with the same name in the same directory, even if they have different extensions.
</blockquote>
<blockquote class="Quote">
Prudence routing rule: route by filename, format/language by extension
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-49"></a>default.*
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-50"></a>URI Templates
</h2>
<div class="Unindented">
See <a class="URL" href="http://www.restlet.org/documentation/2.0/jse/api/org/restlet/util/Resolver.html#createResolver(org.restlet.Request,%20org.restlet.Response)">this</a>.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-51"></a>Virtual Hosts
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-52"></a>Attaching
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-53"></a>Redirecting
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-54"></a>Capturing
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-55"></a>Capturing Errors
</h2>
<div class="Unindented">

<div class="float">

<div class="listing">
<code class="listing">// 404 handler
component.statusService.redirect(404, ’{hi}/404.html’, component.context);
</code>
</div>
</div>
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-8"></a>API
</h1>
<div class="Unindented">
Prudence exposes its API as services to your source code, whether its in scriptlets in /web/dynamic/, complete source code in /resources/, or your configuration scripts.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-56"></a>application
</h2>
<div class="Unindented">
The same ‘‘application’’ service is shared between all code in a single application. Note this there is a single application instance per component, even if the application is routed on several virtual hosts and servers. The ‘‘application’’ service is a good place to store shared state for the application.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-28"></a>application.globals, getGlobal, setGlobal
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-29"></a>application.arguments (for configuration scripts)
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-30"></a>application.application
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-31"></a>application.logger
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-32"></a>application.getMediaType
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-57"></a>document
</h2>
<div class="Unindented">
The ‘‘document’’ service has two distinct uses: first, it represents the file you are in: <i>this</i> document. This is where you can access the document’s attributes and possibly change them. The second use of this service is for accessing <i>other</i> documents. Prudence combines these two uses into one service, but they functionally separate.
</div>
<div class="Indented">
In the case of /resources/ and the configuration scripts, ‘‘this document’’ is simply the source code file. In the case /web/dynamic/, it’s the whole ‘‘text-with-scriptlets’’ page, so it is shared by all scriptlets on the page, even if they are written in different languages.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-28"></a><i>This</i> document:
</h3>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-33"></a>document.source
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-34"></a>document.source.basePath
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-35"></a>document.cache
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-36"></a>document.cache.invalidate
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-37"></a>document.cacheKey
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-38"></a>document.cacheDuration
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-39"></a>document.cacheGroups
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-29"></a><i>Other</i> documents:
</h3>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-40"></a>document.include (/web/dynamic/)
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-41"></a>document.defaultLanguageTag (for include in startup scripts)
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-42"></a>document.internal
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-43"></a>document.external
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-58"></a>executable
</h2>
<div class="Unindented">
The ‘‘executable’’ is the low-level equivalent of ‘‘this document’’ (see above). Here you can explore which languages are installed in your Prudence instance, and gain access to their implementation mechanism. You’ll likely never need to do any of this in your Prudence application. For more information on executables, see Scripturian, the library that handles code execution for Prudence.
</div>
<div class="Indented">
A feature that you might want to use here is the executable globals. These are similar to the application globals (see above), except that they are global to the entire Prudence instance (in fact, to the virtual machine). It’s a good place to store state that you want shared between Prudence applications.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-44"></a>executable.context
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-45"></a>executable.context.writer
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-46"></a>executable.context.attributes
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-47"></a>executable.context.exposedVariables
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-48"></a>executable.manager
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-49"></a>executable.container = the document!
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-50"></a>executable.globals, getGlobal, setGlobal
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-59"></a>conversation
</h2>
<div class="Unindented">
The ‘‘conversation’’ represents the request received from the user. This includes your response to the request, hence it’s a ‘‘conversation.’’ Here you can access various aspects of the request: the URI, formatting preferences, client information, and actual data sent with the request (the ‘‘entity’’). You can likewise set response characteristics.
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-51"></a>conversation.resource
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-52"></a>conversation.request
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-53"></a>conversation.response
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-54"></a>conversation.form, formAll
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-55"></a>conversation.uriValues
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-56"></a>conversation.characterSet Name, Extension
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-57"></a>conversation.language Name, Extension
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-58"></a>conversation.mediaType Name, Extension
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-59"></a>conversation.expirationDate/Timestamp
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-60"></a>conversation.modificationDate/Timestamp
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-61"></a>conversation.tag httpTag
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-62"></a>conversation.maxAge
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-63"></a>conversation.statusCode
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-64"></a>conversation.variant
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-65"></a>conversation.entity
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-66"></a>conversation.internal?
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-67"></a>conversation.addMediaType ByName, ByExtension
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-68"></a>conversation.deferred? (/web/dynamic/)
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-69"></a>conversation.defer (/web/dynamic/)
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-70"></a>conversation.locals
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-71"></a>conversation.kaboom
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-60"></a>Managing State
</h2>
<div class="Unindented">
Application Globals
</div>
<div class="Indented">
Executable Globals
</div>
<div class="Indented">
Conversation Locals
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-9"></a>Debugging
</h1>
<div class="Unindented">
TODO
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-10"></a>Logging
</h1>
<div class="Unindented">
Prudence comes pre-configured with robust logging, based on log4j. You are encouraged to make use of logging in your applications, but even if you don’t, you will still finds the logs useful. Prudence’s servers, routers, language engines and other components all send messages to the logs, making them an invaluable tool for debugging, monitoring and understanding.
</div>
<div class="Indented">
By default, logs are sent to the /logs/ directory, using a configurable rolling log scheme. web.log records all server requests, using Apache’s format, while everything else goes to prudence.log.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-61"></a>Sending Messages
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-62"></a>logging.conf
</h2>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-30"></a>Appenders and Loggers
</h3>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-31"></a>Separate Logs Per Application
</h3>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-63"></a>web.log
</h2>
<div class="Unindented">
You can throw Prudence’s web.log into almost any Apache log file analyzer. Here’s an example using the ubiquitous <a class="URL" href="http://www.analog.cx/">Analog</a>:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">analog \
-C’LOGFORMAT (%Y-%m-%d\t%h:%n:%j\t%S\t%u\t%j\t%j\t%j\t%r\t%q\t%c\t%b\t%j\t%T\t%v\t%B\t%f)’ \
-C’LOCALCHARTDIR local/images/’ \
-C’CHARTDIR images/’ \
-C’HOSTNAME "mysite.org"’ \
log/web.log \
-Oapplications/myapp/web/static/analog/index.html
</code>
</div>
</div>
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-11"></a>Administration
</h1>
<div class="Unindented">
This is a simple app that lets you see the servers, virtual hosts and applications in the Prudence instance, and lets you start and stop them.
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-12"></a>Prudence As a Daemon
</h1>
<div class="Unindented">
In production environments, it’s best to run Prudence as a daemon in Unix-like systems or a service in Windows, via a lightweight wrapper. This will provide proper process monitoring and control. For example, if Prudence’s JVM crashes for some reason, hangs, grabs too much CPU or RAM, the wrapper can automatically shut down and even restart it.
</div>
<div class="Indented">
While Prudence comes with the necessary configuration files for this, it does not include the actual wrapper, which you will need to install manually. There are two reasons for this: YAJSW, our preferred wrapper, is too big a download as of now, and including it in Prudence make it too heavy. As for Tanuki’s JSW, its license will not allow us to distribute it with Prudence. It does not, however, bar you from downloading and installing it yourself.
</div>
<blockquote class="Quote">
Ready for a short history lesson?
</blockquote>
<blockquote class="Quote">
The copyright for JSW is held by its developer, Tanuki Software. Up to version 3.2, Tanuki released JSW under a very permissive license, making it popular in many open source projects. However, it has since been distributed under the GPL 2.0 (and also via a commercial license). We applaud Tanuki’s commitment to open source, and are big fans of the GPL. However, the GPL makes it impossible to distribute JSW with open source projects using less restrictive licenses, such as Prudence. Many projects have kept distributing version 3.2 of JSW, which is now out of date and missing bug fixes.
</blockquote>
<blockquote class="Quote">
For less restrictive open source projects, the gap has been filled by YAJSW, which seeks not only to be a drop-in replacement for JSW, but also to go beyond it with many additional features.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-64"></a>YAJSW
</h2>
<div class="Unindented">
<a class="URL" href="http://yajsw.sourceforge.net/">YAJSW</a> is written in 100% Java, using <a class="URL" href="https://jna.dev.java.net/">JNA</a> to handle the native operating-system-dependent features. It is a powerful tool with many great features.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-65"></a>Monitoring via JMX
</h2>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-66"></a>JSW
</h2>
<div class="Unindented">
<a class="URL" href="http://wrapper.tanukisoftware.org/">JSW</a> is written in C rather than Java, making it more lightweight than YAJSW. Nevertheless, it has binaries for many operating systems.
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-13"></a>HTTP Proxy
</h1>
<div class="Unindented">
There’s nothing special about how Prudence handles HTTP, and it can work easily behind any reverse proxy. This lets you easily unite Prudence with other web servers or run it behind a load balancer. Though it’s not unique to Prudence, we thought to add this section to the documentation in order to get you up and running quickly with this useful scenario.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-67"></a>Perlbal
</h2>
<div class="Unindented">
You can run many instances of Prudence behind a load balancer. This offers fault tolerance, maintenance options, and the possibility to dramatically scale up the number of requests you can support. Your application can tolerate failure of any number of instances, as long as you have one running, because load balancers will automatically route to working instances. Similarly, load balancing allows you to bring some instances down for maintenance while keeping your application up and running.
</div>
<div class="Indented">
Scaling up can be straightforward: simply add more and more instances behind the load balancer, which will make sure to distribute requests among them, while monitoring their responsiveness to accommodate for how well they handle their load. More complex systems can involve different kinds of instances, with the load balancer being in charge of routing requests to the appropriate pool of instances. This ‘‘partitioning’’ can be according to features (one pool handles chat room, one pool handles file downloads), geography (one pool handles England, one pool handles France), or other clever ways to keep the whole system efficient and responsive.
</div>
<div class="Indented">
There are many great load balancers out there, but we especially like <a class="URL" href="http://www.danga.com/perlbal/">Perlbal</a>. Not only is it easy to use and configure, but it also adds a cool feature: instances behind Perlbal can ask it to reroute specific requests. [In the future, we will show you how to do this in Prudence.]
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-68"></a>Apache
</h2>
<div class="Unindented">
<a class="URL" href="http://httpd.apache.org/">Apache</a> is often called the ‘‘Swiss army knife of the Internet’’ for how well it manipulates URLs and routes HTTP requests. Prudence already does powerful routing, including virtual hosting, and that this may be good enough for you. However, Apache is also used a container environment for application platforms as modules, such as mod_php and mod_wsgi. If you have no choice but to run Apache as your front end, it is straightforward to set it to route to Prudence as a reverse proxy.
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-14"></a>Prudence As a Restlet Container
</h1>
<div class="Unindented">
Prudence brings the power of REST and the JVM to programmers in other languages, but has a lot to offer to Java/Restlet developers.
</div>
<div class="Indented">
Though applications can be written in Prudence without a single line of Java code, Prudence also acts as a useful container for existing Restlet applications, Restlet resources or just restlets, written in Java or other JVM languages.
</div>
<div class="Indented">
Why use Prudence for a Restlet application that already works?
</div>
<div class="Indented">
Prudence makes it easy to handle the bootstrapping and <a class="URL" href="../routing/">routing</a> of your applications, and the <a class="URL" href="../prudence-admin/">Prudence administration application</a>, <a class="URL" href="../debugging/">debugging</a> and <a class="URL" href="../logging/">logging</a> features make it easier to deploy and manage multiple applications together. These issues have more to do with your application’s configuration, rather than its functionality, and it can be useful to handle them outside of the Java build process, using live, dynamic languages in simple text source that you can modify on-the-fly. Deploying your Restlet application to a Prudence instance can be as simple as plopping in your jar.
</div>
<div class="Indented">
This need is also fulfilled by servlet and Java Enterprise Edition (JEE) containers, such as Tomcat, Resin and JBoss. Indeed, Restlet has a JEE edition, and good support for servlets. However, if all you need is a deployment container, Prudence can serve as a straightforward, pure REST alternative. 
</div>
<div class="Indented">
Some people also look to JEE containers for their support of Java Server Pages (JSP). We urge you to take a good look at Prudence’s <a class="URL" href="../generating-html/">dynamic web</a> support. It may likely surpass JSP for your purposes. In particular, it is based on Restlet, which you already know and love, with the entire Restlet API at your fingertips. It also lets you use many wonderful languages other than Java for scriptlets. For example, we at Three Crickets, are mad about Clojure. And, of course, Velocity and Succinct are built in. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-69"></a>Summary
</h2>
<div class="Unindented">
A 100% Restlet-based alternative to servlet/JEE containers. (Requires only Restlet SE.)
</div>
<ol>

<li>
Easy deployment
<ol>

<li>
Boot scripts: avoid weird configuration formats and start your Restlet component exactly as you want (in your choice of scripting language) 
</li>
<li>
Default scripts already handle things like virtual hosting, multiple servers and internal routing 
</li>
<li>
Designed from the ground-up to handle multiple apps on the same component 
</li>
<li>
Admin app for realtime management of server(s) 
</li>
<li>
Logging is pre-configured and ‘‘just works,’’ including Apache-compatible web log 
</li>
<li>
Single-file ‘‘plop’’ deployment (like WAR files) 
</li>
</ol>
</li>
<li>
Easy prototyping of REST resources
<ol>

<li>
In the language of your choice 
</li>
<li>
Code is compiled, cached and loaded on-the-fly 
</li>
<li>
Rich debug page for runtime errors 
</li>
<li>
When you’re happy with it, you can rewrite it as a ServerResource in Java 
</li>
</ol>
</li>
<li>
Powerful HTML generation platform, like JSP/ASP/PHP (again, 100% Restlet-based)
<ol>

<li>
In the language of your choice, including mixing languages and template engines (Velocity, Succinct) on one page 
</li>
<li>
Code is compiled, cached and loaded on-the-fly 
</li>
<li>
RAM/db server-side caching (uses Restlet’s URI template language for cache key generation) 
</li>
<li>
Straightforward support for client-side caching 
</li>
<li>
Easily ‘‘stream’’ output (Restlet async) 
</li>
<li>
Easily accept uploaded files 
</li>
<li>
Rich debug page for runtime errors 
</li>
</ol>
</li>
<li>
Restlet sugar 
<ol>

<li>
Fallback router (attach multiple MODE_STARTS_WITH restlets to the same base URI)
</li>
<li>
URI ‘‘capturing’’ (internal redirection; let the URI-space you expose to the world be different from the one you use internally)
</li>
<li>
JavaScript and CSS unify-and-minify filter
</li>
<li>
Delegated status service for displaying custom pages for error codes (404, 500, etc.)
</li>
<li>
Rich debugging representation 
</li>
<li>
Caching system, with pluggable backends, designed for StringRepresentations 
</li>
<li>
Easy file uploads (slightly higher-level than the Restlet FileUpload extension)
</li>
</ol>
</li>
</ol>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-70"></a>Custom Resources
</h2>
<div class="Unindented">
Use your application’s routing file to attach your resources, or otherwise manage routing. Example:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">// Prudence defaults 
document.execute(’defaults/application/routing/’);
​
// MyOrg resources
router.attach(’data/item/{id}’, classLoader.loadClass(’org.myorg.ItemResource’));
router.attach(’data/items’, classLoader.loadClass(’org.myorg.ItemsResource’));
</code>
</div>
</div>
</div>
<div class="Indented">
You can also change Prudence’s default routing by detaching and re-attaching routes:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">// Wrap static web in JavaScript minifying filter
importClass(org.myorg.JavaScriptMinifyFilter);
router.detach(staticWeb);
router.attach(
	fixURL(staticWebBaseURL),
	new JavaScriptMinifyFilter(application.context, staticWeb, File(applicationBasePath + staticWebBasePath)))
	.matchingMode = Template.MODE_STARTS_WITH;
</code>
</div>
</div>
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-71"></a>Custom Application
</h2>
<div class="Unindented">
By default, Prudence creates an instance of the standard Restlet Application class. Use your application’s application file to override this, and create and configure your own application. Example:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">// MyOrgApplication importClass(org.myorg.MyOrgApplication);
var application = new MyOrgApplication();
​
// Install our custom tunnel service
importClass(org.myorg.MyOrgTunnelService);
application.tunnelService = new MyOrgTunnelService(MyOrgTunnelService.MODE_QUERY);
​
// These attributes are specific to MyOrgApplication
application.databaseURI = ’mysql://localhost/myorg’;
application.useTransactions = true;
</code>
</div>
</div>
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-15"></a>How to Choose a Flavor?
</h1>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-72"></a>Python (Succulent!)
</h2>
<div class="Unindented">
<a class="URL" href="http://www.python.org/">Python</a> is a powerful object-oriented language, far richer in features than JavaScript and PHP, with many high-quality core and 3rd party libraries. Python has already proven itself as a web programming language with many excellent platforms.
</div>
<div class="Indented">
Python presents a unique challenge in a scriptlet environment, due to its reliance on indentation. However, because HTML is loose with whitespace, it’s possible to force the whole file to adhere to Python’s scheme. In fact, as many Python enthusiasts would argue, forcing your code to adhere to Python’s indentation requirements can go a long way towards making it more readable and manageable.
</div>
<div class="Indented">
In the included example application we show how to use <a class="URL" href="http://www.sqlalchemy.org/">SQLAlchemy</a> as a data backend for Prudence.
</div>
<blockquote class="Quote">
Note: Prudence Python was built primarily around <a class="URL" href="http://www.jython.org/">Jython</a>, but also offers limited support for <a class="URL" href="http://jepp.sourceforge.net/">Jepp</a> if it’s installed. For those cases where you need access to a natively built Python library that won’t work on Jython, Jepp lets you run code on the CPython platform.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-73"></a>Ruby (Delectable!)
</h2>
<div class="Unindented">
<a class="URL" href="http://www.ruby-lang.org/">Ruby</a> can do most of what Python can do and more. A true chameleon, it can adapt to many styles of code and programming. If something can be possible, Ruby allows it and supports it. Unlike Python, it has a very loose and forgiving syntax, which is perfect for scriptlets.
</div>
<div class="Indented">
Ruby’s <a class="URL" href="http://rubyonrails.org/">Rails</a> platform has revolutionized web programming by offering elegant, powerful alternatives to working directly with HTTP. We hope Ruby web programmers will find in Prudence a refreshing alternative to Rails: elegantly embracing HTTP, instead of avoiding it.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-74"></a>Clojure (Scrumptious!)
</h2>
<div class="Unindented">
Prudence’s only functional flavor is a Lisp designed from the ground up for high concurrency. If you’re serious about scaling, <a class="URL" href="http://clojure.org/">Clojure</a> is the way to go. Though new, Clojure is based on one of the oldest programming languages around, and enjoys a rich tradition of elegant solutions for tough programming challenges.
</div>
<div class="Indented">
Clojure embraces the JVM, but also has a growing collection of nifty ‘‘contrib’’ libraries---all included in Prudence. In the included example application, we show how to use Clojure’s SQL library to access a data backend the Clojure way.
</div>
<div class="Indented">
Three Crickets ♥ Clojure. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-75"></a>JavaScript (Savory!)
</h2>
<div class="Unindented">
<a class="URL" href="https://developer.mozilla.org/en/JavaScript">JavaScript</a> (a dialect of <a class="URL" href="http://www.ecmascript.org/">ECMAScript</a>) is a sensible choice for ‘‘AJAX’’ and other rich web client applications, because it’s the same language used by web browsers and other client platforms. Web developers are already proficient in JavaScript, and can quickly be brought on board to a server-side project. JavaScript lets you to write server-side and client-side code in the same language, and have both sides share code. Couple it with <a class="URL" href="http://www.json.org/">JSON</a>, and you’re on solid ground for rapid development. Of all the web programming languages, it’s the one most widely deployed and with the most secure future.
</div>
<div class="Indented">
JavaScript is an under-appreciated language. Though not as feature-rich as Python or Ruby, it’s still very powerful. Its straightforward closure/prototype mechanisms allow it to support object-orientation, namespaces and other paradigms. It’s also been the target of much un-deserved angst due to the fickleness of in-browser development. Working with the DOM, cross-browser HTML rendering quirks---none of these are the faults of the language itself, and none of these are relevant to server-side development with Prudence.
</div>
<div class="Indented">
JavaScript does not have its own core libraries, making it the most minimal Prudence flavor. But this isn’t necessarily a deficiency: instead, it uses the excellent JVM core.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-76"></a>PHP (Ambrosial!)
</h2>
<div class="Unindented">
<a class="URL" href="http://www.php.net/">PHP</a>is, of course, ubiquitous. It’s a simple language with the most mature libraries of any web programming language, and programmers are available with years of experience. It’s also designed from the ground up as a programming language for the web.
</div>
<div class="Indented">
Prudence allows a smooth transition from traditional PHP HTML generation to REST resources. It supports PHP ‘‘superglobals’’ such as $_GET, $_POST, $_COOKIE and $_FILE (but not $_SESSION) to make you feel right at home. It also adds many new features to conventional HTML generation: fine-grained caching, high-performance templating languages, and more.
</div>
<blockquote class="Quote">
Note: Prudence PHP was built around the open source edition of <a class="URL" href="http://quercus.caucho.com/Quercus">Quercus</a>, which does not feature JVM bytecode compilation as is available in the non-free professional edition. Nevertheless, we found it an excellent performer!
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-77"></a>Groovy (Luscious!)
</h2>
<div class="Unindented">
In some ways, <a class="URL" href="http://groovy.codehaus.org/">Groovy</a> is the best of this bunch. It has all the flexibility of Ruby, but is designed from the ground up to enhance and extend Java. Java programmers would immediately feel at home, while gaining access to far less restrictive programming paradigms. Groovy makes Java... groovy.
</div>
<div class="Indented">
If you know your project will require a lot of interaction with Java libraries, Groovy is a terrific---and fun!---choice. (Note that other Prudence flavors also offer JVM interaction, but Groovy does it best.) 
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-16"></a>The Case for REST
</h1>
<div class="Unindented">
There’s a lot of buzz about REST, but also a lot confusion about what it is and what it’s good for. The essay attempts to convey its simple essence.
</div>
<div class="Indented">
Let’s start, then, not at REST, but at an attempt to create a new architecture for building scalabale applications. Our goals are for it to be minimal, straightforward, and still have enough features to be productive. We want to learn some lessons from the failures of other, more elaborate and ‘‘complete’’ architectures.
</div>
<div class="Indented">
Let’s call ours a ‘‘resource-oriented architecture.’’
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-78"></a>Resources
</h2>
<div class="Unindented">
Our base unit is a ‘‘resource,’’ which, like an object in object-oriented architectures, encapsulates data with some functionality. However, we’ve learned from object-orientation that implementing arbitrary interfaces is a recipe for enormous complexity. Instead, then, we’ll keep it simple and define a limited interface that would still be useful enough.
</div>
<div class="Indented">
From our experience with relational databases, we’ve learned that a tremendous amount of power can be found in ‘‘CRUD’’: Create, Read, Update and Delete. If we support just these operations, our resources will already be very powerful, enjoying the accumulated wisdom and design patterns from the database world. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-79"></a>Identifiers
</h2>
<div class="Unindented">
First, let’s start with a way of discriminating our resources. We’ll define a name-based address space where our resources live. Each resource is ‘‘attached’’ to one or more addresses. We’ll allow for ‘‘/’’ as a customary separator to allow for hierarchical addressing schemes. For example:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">/animal/cat/12/image
/animal/cat/12/image/large
/animal/cat/12/specs
</code>
</div>
</div>
</div>
<div class="Indented">
In the above, we’ve allowed for different kinds of animals, a way of referencing individual animals, and a way of referencing specific aspects of these animals. Let’s now go over CRUD operations in order of complexity.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-80"></a>Delete
</h2>
<div class="Unindented">
‘‘Delete’’ is the most trivial operation. After sending ‘‘delete’’ to an identifier, we expect it to not exist anymore. Whether or not sub-resources in our hierarchy can exist or not, we’d leave up to individual implementations. For example, deleting ‘‘/animal/cat/12/image’’ may or may not delete ‘‘/animal/cat/12/image/large’’.
</div>
<div class="Indented">
Note that we don’t care about atomicity here, because we don’t expect anything after our ‘‘delete’’ operation. A million changes can happen to our cat before our command is processed, but they’re all forgotten after ‘‘delete.’’ (See ‘‘update,’’ below, for a small caveat.)
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-81"></a>Read
</h2>
<div class="Unindented">
‘‘Read’’ is a bit more complicated than ‘‘delete.’’ Since we expect our resource to change, we want to make sure that there’s some kind of way to mark which version we are reading. This will allow us to avoid unnecessary reads if there hasn’t been any change.
</div>
<div class="Indented">
We’ll need our resource-oriented architecture to support some kind of version tagging feature.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-82"></a>Update
</h2>
<div class="Unindented">
The problem with ‘‘update’’ is that it always references a certain version that we have ‘‘read’’ before. In some cases, though not all, we need some way to make sure that the data we expect to be there hasn’t changed since we’ve last ‘‘read’’ it. Let’s call this a ‘‘conditional update.’’
</div>
<div class="Indented">
Actually, we’ve oversimplified our earlier definition of ‘‘delete.’’ In some cases, we’d want a ‘‘conditional delete’’ to depend on certain expectations about the data. We might not want the resource deleted in some cases.
</div>
<div class="Indented">
We’ll need our resource-oriented architecture to support a ‘‘conditional’’ feature. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-83"></a>Create
</h2>
<div class="Unindented">
This is our most complex operation. Our first problem is that our identifier might not exist yet. One approach could be to try identifiers in sequence:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">Create: /animal/cat/13 -&gt; Error, already exists
Create: /animal/cat/14 -&gt; Error, already exists
Create: /animal/cat/15 -&gt; Error, already exists
...
Create: /animal/cat/302041 -&gt; Success!
</code>
</div>
</div>
</div>
<div class="Indented">
Obviously, this is not a scalable solution. Another approach could be to have a helper resource which provides us with the necessary ID:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">Read: /animal/cat/next -&gt; 14
Create: /animal/cat/14 -&gt; Oops, someone else beat us to 14!
Read: /animal/cat/next -&gt; 15
Create: /animal/cat/15 -&gt; Success!
</code>
</div>
</div>
</div>
<div class="Indented">
Of course, we can also have ‘‘/animal/cat/next’’ return IDs that are never used and avoid duplications. If we never create our cat, they will be wasted, though. The main problem with this approach is that it requires two calls per creation: a ‘‘read,’’ and then a ‘‘create.’’ We can handle this in one call by allowing for ‘‘partial’’ creation:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">Create: /animal/cat -&gt; We send the data for the cat without the ID, and get back the ID
</code>
</div>
</div>
</div>
<div class="Indented">
Other solutions exist, too. The point of this discussion is to show you that ‘‘create’’ is not trivial, but also that solutions to ‘‘create’’ exist within the resource-oriented architecture we’ve defined. ‘‘Create,’’ though complex, does not demand any new features. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-84"></a>Aggregate Resources
</h2>
<div class="Unindented">
At first glance, handling the problem of getting lots of resources at the same time, thus saving on the number of calls, can trivially be handled by the features we’ve listed so far. A common solution is to define a ‘‘plural’’ version of the ‘‘singular’’ resource:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">/animal/cats
</code>
</div>
</div>
</div>
<div class="Indented">
A ‘‘read’’ would give us all cats. But what if there are ten million cats? We can support paging. Again, we have a solution within our current feature set, using identifiers for each subset of cats:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">/animal/cats/100/200
</code>
</div>
</div>
</div>
<div class="Indented">
The above would return no more than 100 cats: from the 100th, to the 200th. There’s a slight problem in this solution: the burden is on whatever component in our system handles mapping identifiers to resources. This is not terrible, but if we want our system to be more generic, it could help if things like ‘‘100 to 200’’ could be handled by our resource more directly. For this convenience, let’s implement a simple parameter system for all commands:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">Read(100, 200): /animal/cats
</code>
</div>
</div>
</div>
<div class="Indented">
In the above, our mapping component only needs to know ‘‘/animal/cats’’. It can be very dumb, and easy to implement. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-85"></a>Formats
</h2>
<div class="Unindented">
The problem of supporting multiple formats seems similar, at first glance, to that of aggregate resources. Again, we could potentially solve it with command parameters:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">Read(UTF-8, Russian): /animal/cat/13
</code>
</div>
</div>
</div>
<div class="Indented">
This would give us a Russian, Unicode UTF-8 encoded version of our cat. Looks good, except that there is a potential problem. The client might prefer certain formats, but actually be able to handle others. We would not want a series of wasteful operations to happen until one succeeds. Of course, we can have another resource where all available formats are listed, but this would require an extra call, and also introduce the problem of atomicity. A better solution would be to have the client associate certain preferences per command, have our resource emit its capabilities, with mapping component in between ‘‘negotiating’’ these two lists, via a simple algorithm, and choose the best mutually preferable format.
</div>
<div class="Indented">
This would be a simple feature to add to our resource-oriented architecture, which could greatly help to decouple its support for multiple formats from its addressing scheme. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-86"></a>Shared State
</h2>
<div class="Unindented">
Shared state between the client and server is very useful for managing sessions, and implementing basic security. Of course, it’s quite easy to abuse shared state, too, by treating it as a cache for data. We don’t want to encourage that. Instead, we just want a very simple shared state system.
</div>
<div class="Indented">
We’ll allow for this by attaching small, named, shared state objects to every request and response to a command. Nothing fancy or elaborate. There is a potential security breach here, so we have to trust that all components along the way honor the relationship between client and server, and don’t allow other servers access to our shared state. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-87"></a>Summary of Features
</h2>
<div class="Unindented">
So, what do we need?
</div>
<div class="Indented">
We need a way to map identifiers to resources. We need support for the four CRUD operations. We need support for ‘‘conditional’’ updates and deletes. We need all operations to support ‘‘parameters.’’ We need ‘‘negotiation’’ of formats. And, we need a simple shared state attachment feature.
</div>
<div class="Indented">
This list is very easy to implement. It requires very little computing power, and no support for generic, arbitrary additions.
</div>
<div class="Indented">
Before we go on, it’s worth mentioning one important feature which we did not require: transactions. Transactions are optional, and sometimes core features in many databases and distributed object systems. They can be extremely powerful, as they allow atomicity across an arbitrary number of commands. They are also, however, heavy to implement, as they require considerable shared state between client and server. Powerful as they are, it is possible to live without them. It’s possible, for example, to implement this atomicity within a single resource. This would require us to define special resources per type of transaction which we want to support, but it does remove the heavy burden of supporting arbitrary transactions from our architecture. With some small reluctance, then, we’ll do without transactions. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-88"></a>Let’s Do It!
</h2>
<div class="Unindented">
OK, so now we know what we need, let’s go ahead and implement the infrastructure of components to handle our requirements. All we need is stacks for all supported clients, backend stacks for all our potential server platforms, middleware components to handle all the identifier routing, content negotiation, caching of data...
</div>
<div class="Indented">
...And thousands of man hours to develop, test, deploy, and integrate. Like any large-scale, enterprise architecture, even trivial requirements have to jump through the usual hoops set up by the sheer scale of the task. Behind every great architecture are the nuts and bolts of the infrastructure.
</div>
<div class="Indented">
Wouldn’t it be great if the infrastructure already existed?
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-89"></a>The Punchline
</h2>
<div class="Unindented">
Well, duh. All the requirements for our resource-oriented architecture are already supported by HTTP:
</div>
<div class="Indented">
Our resource identifiers are simple URLs. The CRUD operations are in the four HTTP verbs: PUT, GET, POST and DELETE. ‘‘Conditional’’ and ‘‘negotiated’’ modes are handled by headers, as are ‘‘cookies’’ for shared state. Version stamps are e-tags. Command parameters are query matrixes appended to URLs. It’s all there.
</div>
<div class="Indented">
Most importantly, the infrastructure for HTTP is already fully deployed world-wide. TCP/IP stacks are part of practically every operating system; wiring, switching and routing are part and parcel; HTTP gateways, firewalls, load balancers, proxies, caches, filters, etc., are stable consumer components; certificate authorities, national laws, international agreements are already in place to support the complex inter-business interaction. Importantly, this infrastructure is successfully maintained, with minimal down-time, by highly-skilled independent technicians, organizations and component vendors across the world.
</div>
<div class="Indented">
It’s important to note a dependency and possible limitation of HTTP: it is bound to TCP/IP. Indeed, all identifiers are URLs: Uniform Resource Locators. In URLs, the first segment is reserved for the domain, either an IP address or a domain name translatable to an IP address. Compare this with the more general URIs (Uniform Resource Identifiers), which do not have this requirement. Though we’ll often be tied to HTTP in REST, you’ll see the literature attempting, at least, to be more generic. There are definitely use cases for non-HTTP, and even non-TCP/IP addressing schemes. In Prudence, you’ll see that it’s possible to <a class="URL" href="http://localhost:8080/prudence-guide/rest/guide/resources">address internal resources with non-URL kinds of URIs</a>. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-90"></a>It’s All About Infrastructure
</h2>
<div class="Unindented">
The most important lesson to take from this experience is the importance of infrastructure. This is why, I believe, Roy Fielding named <a class="URL" href="http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm">Chapter 5 of his 2000 dissertation</a> ‘‘Representational State Transfer’’ rather than, say, ‘‘resource-oriented architecture,’’ as we have here. Fielding, one of the authors of the HTTP protocol, was intimately familiar with its challenges, and the name is intended to point out the key characteristic of its infrastructure: it’s all about the transfer of lightly annotated data representations. ‘‘Resources’’ are merely logical encapsulations of these representations, depending on a contract between client and server. The infrastructure does not, in itself, do anything in particular to maintain, say, a sensible hierarchy of addresses, the atomicity of CRUD operations, etc. That’s up to your implementation. But, representational state transfer---REST---is the mundane, underlying magic that makes it all possible.
</div>
<div class="Indented">
To put it succinctly, a resource-oriented architecture requires a REST infrastructure. Practically, the two terms become interchangeable.
</div>
<div class="Indented">
The principles of resource-orientation can and are applied in many systems. The word wide web, of course, with its ecology of web browsers, web servers, certificate authorities, etc., is the most obvious model. But other core internet systems, such as email (SMTP, POP, IMAP), file transfer (FTP, WebDAV) also implement some subset of REST. Your application can do this, too, and enjoy the same potential for scalability as the above. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-91"></a>Does REST Scale?
</h2>
<div class="Unindented">
Part of the buzz about REST is that it’s an inherently scalable architecture. This is true, but perhaps not in the way that you think.
</div>
<div class="Indented">
Consider that there are two uses of the term ‘‘scalable’’:
</div>
<div class="Indented">
First, it’s the ability to respond to a growing number of user requests without degradation in response time, by ‘‘simply’’ adding hardware. This is the aspect of scalability that engineers care about. The simple answer is that REST can help, but it doesn’t stand out. SOAP can also do it pretty well. REST aficionados sometimes point out that REST is ‘‘stateless,’’ or ‘‘session-less,’’ both characteristics that would definitely help scale. But, this is misleading. Protocols might be stateless, but architectures built on top of them don’t have to be. For example, we’ve specifically talked about sessions here. And, you can easily make poorly scalable REST. The bottom line is that there’s nothing in REST that guarantees scalability in <i>this</i> respect. Indeed, engineers coming to REST due to this false lure end up wondering what the big deal is.
</div>
<div class="Indented">
The second use of ‘‘scalability’’ comes from the realm of enterprise and project management. It’s the ability of your project to grow in complexity without degradation in your ability to manage it. And that’s REST’s beauty---you already have the infrastructure, which is the hardest thing to scale in a project. You don’t need to deploy client stacks. You don’t need to create and update proxy objects for five different programming languages used in your enterprise. You don’t need to deploy incompatible middleware by three different vendors and spend weeks trying to force them to play well together. Why would engineers care about REST? Precisely because they don’t have to: they can focus on engineering, rather than get bogged down by infrastructure management.
</div>
<div class="Indented">
That said, a ‘‘resource-oriented architecture’’ as we defined here is not a bad start for (engineering-wise) scalable systems. Keep your extras lightweight, minimize or eliminate shared state, and encapsulate your resources according to use cases, and you won’t, at least, create any obstacles to scaling. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-92"></a>Prudence
</h2>
<div class="Unindented">
Convinced? The best way to understand REST is to experiment with it. You’ve come to the right place. Start with the <a class="URL" href="../guide/tutorial/">Prudence tutorial</a>, and feel free to skip around the documentation and try things out for yourself. You’ll find it easy, fun, and powerful enough for you to create large-scale applications that take full advantage of the inherently scalable infrastructure of REST. Happy RESTing! 
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-17"></a>Scaling Tips
</h1>
<div class="Unindented">
If you want your application to handle many concurrent users, then you are fighting this fact: a request will get queued in the best case or discarded in the worst case if there is no thread available to serve it.
</div>
<div class="Indented">
Two variables influence this: 1) your total number of threads and 2) the time it takes each thread to process a request. Increasing the number of threads is straightforward: you keep adding more and more machines behind load balancers. The only challenge in this respect is financial. On the other hand, the time per request has little to do with your computer power. In fact, for various reasons it can grow longer as you keep adding threads. Minimizing the time per request is a design challenge.
</div>
<div class="Indented">
Your design objective is to increase concurrency, not necessarily performance. Optimizing for concurrency means breaking up tasks to as many pieces as possible, and possibly even breaking requests into smaller pieces. We’ll cover numerous strategies here.
</div>
<div class="Indented">
Meanwhile, feel free to frame these inspirational slogans on your wall:
</div>
<blockquote class="Quote">
Requests are hot potatoes: Pass them on!
</blockquote>
<blockquote class="Quote">
And:
</blockquote>
<blockquote class="Quote">
It’s better to have many short requests than one long one.
</blockquote>
<div class="Unindented">
Finally, a favorite:
</div>
<blockquote class="Quote">
Performance does not equal scalability.<br>
Performance does not equal scalability.<br>
Performance does not equal scalability.
</blockquote>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-93"></a>Caching
</h2>
<div class="Unindented">
Retrieving from a cache can be orders of magnitude faster than dynamically processing a request. It’s your most powerful tool for increasing concurrency.
</div>
<div class="Indented">
Caching, however, is only effective is there’s something in the cache. It’s pointless to cache fragments that appear only to one user on only one page that they won’t return to. On the other hand, there may very well be fragments on the page that will recur often. If you design your page carefully to allow for fragmentation, you will reap the benefits of fine-grained caching. Remember, though, that the outermost fragment’s expiration defines the expiration of the included fragments. It’s thus good practice to define no caching on the page itself, and only to cache fragments.
</div>
<div class="Indented">
In your plan for fine-grained caching, take special care to isolate those fragments that cannot be cached, and cache everything around them.
</div>
<div class="Indented">
Make sure to change Prudence’s cacheKey to fit the lowest common denominator: you want as many possible requests to use the already-cached data, rather than generating new data. Note that, by default, Prudence includes the request URI in the cacheKey. Fragments, though, may very well appear identically in many different URIs. You would thus not want the URI as part of their cacheKey.
</div>
<div class="Indented">
Cache aggressively, but also take cache validation seriously. Make good use of Prudence’s cacheGroups to allow you to invalidate portions of the cache that should be updated as data changes. Note, though, that every time you invalidate you will lose caching benefits. If possible, make sure that your cacheGroups don’t include too many pages. Invalidate only those entries that really need to be invalidated.
</div>
<div class="Indented">
(It’s sad that many popular web sites do cache validation so poorly. Users have come to expect that sometimes they see wrong, outdated data on a page, sometimes mixed with up-to-date data. The problem is usually solved within minutes, or after a few browser refreshes, but please do strive for a better user experience in your web site!)
</div>
<div class="Indented">
If you’re using a deferrable task handler, you might want to invalidate cache groups when tasks are done. Consider creating a special internal API that lets the task handler call back to your application to do this.
</div>
<div class="Indented">
How long should you cache? As long as the user can bear! In a perfect world, of limitless computing resources, all pages would always be generated freshly per request. In a great many cases, however, there is no harm at all if users see some data that’s a few hours or a few days old.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-94"></a>Necessary Tasks
</h2>
<div class="Unindented">
<i>The user can’t continue without the task being resolved.</i>
</div>
<div class="Indented">
If the necessary task is deterministically fast, you can do all processing in the request iself.
</div>
<div class="Indented">
If not, you should queue the task on a handling service and return a ‘‘please wait’’ page to the user. It woule be nice to add a progress bar or some other kind of estimation of how long it would take for the task to be done. The client will poll until the task status is marked ‘‘done,’’ after which they will be redirected somewhere else. Each polling request sent by the client could likely be processed very quickly, so this this strategy effectively breaks the task into many small requests (‘‘It’s better to have many short requests than one long one’’).
</div>
<div class="Indented">
Implementing a handling service is by no means trivial. It adds a new component to your architecture, one that also has to be made to scale. One can also argue that it adversely affects user experience by adding overhead, delaying the time it takes for the tast to complete. The bottom line, though, is you’re vastly increasing concurrency and your ability to scale. And, you’re actually improving the user experience: they would get a feedback on what’s going on rather than having their browsers spin, waiting for their requests to complete.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-95"></a>Deferrable Tasks
</h2>
<div class="Unindented">
<i>It’s OK if the task occurs later.</i>
</div>
<div class="Indented">
As with necessary tasks, you can queue these with a task handling service, but it’s much simpler because you don’t have to keep track of status or display it to the user. This allows you to use a simpler---and more scalable---task handling service.
</div>
<div class="Indented">
Deferring tasks does present a challenge to the user experience: What do you do if the task fails, and the user needs to know about it? One solution can be to send a warning email or other kind of message to the user. Another solution could be to have your client constantly poll in the background (via ‘‘AJAX’’) to see if there are any error messages, which in turn might require you to keep a queue of such error messages per user.
</div>
<div class="Indented">
Before you decide on deferring a task, think carefully of the user experience: for example, users might be constantly refreshing a web page waiting to see the results of their operation. Perhaps the task you thought is deferrable should actually be considered necessary?
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-96"></a>Uploads
</h2>
<div class="Unindented">
File uploads are very long tasks that you cannot break into smaller tasks, because they depend entirely on the client. As such, they present a unique challenge to scalability.
</div>
<div class="Indented">
Fortunately, Prudence handles client requests via non-blocking I/O, meaning that large file uploads will not hold on to a single thread for the duration of the upload.
</div>
<div class="Indented">
Unfortunately, many concurrent uploads will still saturate your threads. If your application relies on file uploads, you are advised to handle such requests on separate Prudence instances, so that uploads won’t stop your application from handling other web requests.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-97"></a>Asynchronous Processing
</h2>
<div class="Unindented">
Having the client poll until a task is completed lets you break up a task into multiple requests and increase concurrency. Another strategy is to be break an <i>individual request</i> into pieces. While you’re processing the request and preparing the response, you can free the web thread to handle other requests. When you’re ready to deliver content, you raise a signal, and the next available web thread takes care of sending your response to the client. You can continue doing this indefinitely until the response is complete. From the client’s perspective it’s a single request: a web browser, for example, would spin until the request was completed.
</div>
<div class="Indented">
You might be adding some extra time overhead for the thread-switching on your end, but the benefits for scalability are obvious: you are increasing concurrency by shortening the time you are holding on to web threads.
</div>
<div class="Indented">
For web services that deliver heavy content, such as images, video, audio, it’s absolutely necessary. Without it, a single user could tie up a thread for minutes, if not hours. You would still get degraded performance if you have more concurrent users than you have threads, but at least degradation will be shared among users. Without asynchronous processing, each user would tie up one thread, and when that finite resource is used up, more users won’t be able to access your service.
</div>
<div class="Indented">
Even for lightweight content such as HTML web pages, asynchronous processing can be a good tactic for increasing concurrency. For example, if you need to fetch data from a backend with non-deterministic response time, it’s best to free the web thread until you actually have content available for the response.
</div>
<div class="Indented">
It’s not a good idea to do this for every page. While it’s better to have many short requests instead of one long one, it’s obviously better to have one short request rather than many short ones. Which web requests are good candidates for asynchronous processing?
</div>
<ol>

<li>
Requests that do a few independent operations.
</li>
<li>
Requests that must access backend services with non-deterministic response times.
</li>
</ol>
<div class="Unindented">
And, even for #2, if the service can take a <i>very</i> long time to respond, consider that it might be better to queue the task on a task handler and give proper feedback to the user.
</div>
<div class="Indented">
And so, after this lengthy discussion, it turns out that asynchronous processing is not such a useful strategy for increasing concurrency in web applications. Caching is far more useful.
</div>
<div class="Indented">
As of version 1.0, Prudence has limited support for asynchronous processing, via conversation.defer.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-98"></a>Data Backends
</h2>
<div class="Unindented">
You can keeping adding more nodes behind a load balancer insofar as each request does not have to access shared state. Useful web applications, however, are likely data-driven.
</div>
<div class="Indented">
If the challenge in handling web requests is cutting down the length of request, then that of relational data backends is the struggle against degraded performance as you add new nodes to your database cluster. These nodes have to be synchronized with each other, and that synchronization overhead increases exponentially. There’s a definite point of diminishing returns.
</div>
<div class="Indented">
Fortunately, there are workable strategies for scaling data backends. Unfortunately, they all have limitations, and must be carefully selected for your application’s needs.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-99"></a>Graph Databases
</h2>
<div class="Unindented">
If your relational data structure contains a lot of many-to-many relationships and ‘‘generic’’ relationships forced into a relational model, then consider using a graph database instead. Not only will your queries be faster, but also the database structure will allow for more efficient replication, and thus scalability. The improvement over relational databases can be dramatic.
</div>
<div class="Indented">
Social networking applications are often used as examples of graph structures, but there are many others: forums with threaded and cross-referenced discussions, semantic knowledge bases, music ‘‘genomes,’’ user-tagged media sharing sites, and many science and engineering applications.
</div>
<div class="Indented">
Though fast, querying a complex graph can be difficult to prototype. Fortunately, the <a class="URL" href="http://wiki.github.com/tinkerpop/gremlin/">Gremlin</a> and <a class="URL" href="http://www.w3.org/TR/rdf-sparql-query/">SPARQL</a> languages do for graphs what SQL does for relational databases. Your query becomes coherent and portable.
</div>
<div class="Indented">
A popular graph database is <a class="URL" href="http://neo4j.org/">Neo4j</a>, and it’s perfect for Prudence. Because it’s JVM-based, you can access it internally from Prudence. It also supports a REST interface which you can easily access via Prudence’s document.external.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-100"></a>Document Databases
</h2>
<div class="Unindented">
If your data contains mostly ‘‘documents’’---self-contained records with few relationships to other documents---then consider a document database. 
</div>
<div class="Indented">
Document databases allow for straightforward distribution and very fine-grained replication, requiring considerably less overhead than relational and graph databases. Document databases are almost limitlessly scalable.
</div>
<div class="Indented">
The cost of this scalability is the loss of your ability to do relational queries of your data. Instead, you’ll be using distributed map/reduce, or rely on an external indexing service. These are powerful tools, but they do not match relational queries in sheer speed of complex queries. Implementing something as simple as a many-to-many connection, the bread-and-butter of relational databases, requires some specialization. Document databases shine at listing, sorting and searching through extremely large catalogs of documents.
</div>
<div class="Indented">
Candidate applications include online retail, blogs, wikis, archives, newspapers, contact lists, calendars, photo galleries, dating profiles... This is a long list, but by no means exhaustive of all that is possible in web applications. Many useful applications cannot be reduced to sets of lightly interconnected ‘‘documents’’ without giving up a lot of useful functionality. For example, merely adding social networking capabilities to a dating site would require complex relations that might be better handled with a graph database.
</div>
<div class="Indented">
A popular document database is <a class="URL" href="http://www.mongodb.org/">MongoDB</a>. It enables a few basic relational features, while easily scaling to vast amounts of documents. Another is <a class="URL" href="http://couchdb.apache.org/">CouchDB</a>, which is a truly distributed database. With CouchDB it’s trivial to replicate and synchronize data with clients’ desktops or mobile devices, and to distribute it to partners. It also supports a REST interface which you can easily access via Prudence’s document.external.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-101"></a>Best of All Worlds
</h2>
<div class="Unindented">
Of course, consider that it’s very possible to use both SQL and ‘‘NoSQL’’ (graph, document) databases together for different parts of your application.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-102"></a>Powering Up
</h2>
<div class="Unindented">
The database is one place where high-performance hardware can help. Ten expensive, powerful machines might be equal in total power to forty cheap machines, but they require a quarter of the synchronization overhead, giving you more elbow room to scale up. Fewer nodes is better.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-103"></a>Partitioning
</h2>
<div class="Unindented">
Partitioning is as useful to relational database scaling as caching is to web request scaling.
</div>
<div class="Indented">
Rather than having one big cluster of identical databases, you will have several smaller clusters of different, independent databases. This lets you add nodes to each cluster without spreading synchronization overhead everywhere. The more partitions you can create, the better you’ll be able to scale.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-32"></a>Reads vs. Writes
</h3>
<div class="Unindented">
This simple partitioning scheme greatly reduces synchronization overhead. Read-only servers will never send data to the writable servers. Also, knowing that they don’t have to handle writes means you can optimize their configurations for aggressive caching.
</div>
<div class="Indented">
(In fact, some database synchronization systems will only let you create this kind of cluster, providing you with one ‘‘master’’ writable node and several read-only ‘‘slaves.’’ They force you to partition!)
</div>
<div class="Indented">
Another nice thing about read/write partitioning is that you can easily add it to all the other strategies. Any cluster can thus be divided into two.
</div>
<div class="Indented">
Of course, for web services that are heavily balanced towards writes, this is not an effective strategy. For example, if you are implementing an auditing service that is constantly being bombarded by incoming data, but is only queried once in a while, then an extra read-only node won’t help you scale.
</div>
<div class="Indented">
Note that one feature you lose is the ability to have a transaction in which a write <i>might</i> happen, because a transaction cannot contain both a read-only node and a write-only node. If you must have atomicity, you will have to do your transaction on the writable cluster, or have two transactions: one to lookup and see if you need to change the data, and the second to perform the change---while first checking again that data didn’t change since the previous transaction. Too much of this obviously lessens the effectiveness of read/write partitioning.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-33"></a>By Feature
</h3>
<div class="Unindented">
The most obvious and effective partitioning scheme is by feature. Your site might offer different kinds of services that are functionally independent of each other, even though they are displayed to users as united. Behind the scenes, each feature uses a different set of tables. The rule of thumb is trivial: if you can put the tables in separate databases, then you can put them these databases in separate clusters.
</div>
<div class="Indented">
One concern in feature-based partitioning is that there are a few tables that still need to be shared. For example, even though the features are separate, they all depend on user settings that are stored in one table.
</div>
<div class="Indented">
The good news is that it can be cheap to synchronize just this one table between all clusters. Especially if this table doesn’t change often---how often do you get new users signing up for your service?---then synchronization overhead will be minimal.
</div>
<div class="Indented">
If your database system doesn’t let you synchronize individual tables, then you can do it in your code by writing to all clusters at the same time.
</div>
<div class="Indented">
Partitioning by feature is terrific in that it lets you partition other parts of the stack, too. For example, you can also use a different set of web servers for each feature.
</div>
<div class="Indented">
Also consider that some features might be candidates for using a ‘‘NoSQL’’ database. Choose the best backend for each feature.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-34"></a>By Section
</h3>
<div class="Unindented">
Another kind of partitioning is sometimes called ‘‘sharding.’’ It involves splitting up tables into sections that can be placed in different databases. Some databases support sharding as part of their synchronization strategy, but you can also implement it in your code. The great thing about sharding is that it lets you create as many shards (and clusters) as you want. It’s the key to the truly large scale.
</div>
<div class="Indented">
Unfortunately, like partitioning by feature, sharding is not always possible. You need to also shard all related tables, so that queries can be self-contained within each shard. It’s thus most appropriate for one-to-many data hierarchies. For example, if your application is a blog that supports comments, then you put some blogs and their comments on one shard, and others in another shard. However, if, say, you have a feature where blog posts can refer to other arbitrary blog posts, then querying for those would have to cross shard boundaries.
</div>
<div class="Indented">
The best way to see where sharding is possible is to draw a diagram of your table relationships. Places in the diagram which look like individual trees---trunks spreading out into branches and twigs---are good candidates for sharding.
</div>
<div class="Indented">
How to decide which data goes in which shard?
</div>
<div class="Indented">
Sometimes the best strategy is arbitrary. For example, put all the even-numbered IDs in one shard, and the odd-numbered ones in another. This allows for straightforward growth because you can just switch it to division by three if you want three shards. 
</div>
<div class="Indented">
Another strategy might seem obvious: If you’re running a site which shows different sets of data to different users, then why not implement it as essentially separate sites? For example, a social networking site strictly organized around individual cities could have separate database clusters per city.
</div>
<div class="Indented">
A ‘‘region’’ can be geographical, but also topical. For example, a site hosting dance-related discussion forums might have one cluster for ballet and one for tango. A ‘‘region’’ can also refer to user types. For example, your social networking site could be partitioned according to age groups.
</div>
<div class="Indented">
The only limitation is queries. You can still let users access profiles in other regions, but cross-regional relational queries won’t be possible. Depending on what your application does, this could be a reasonable solution.
</div>
<div class="Indented">
A great side-benefit to geographical partitioning is that you can host your servers at data centers within the geographical location, leading to better user experiences. Regional partitioning is useful even for ‘‘NoSQL’’ databases.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-104"></a>Coding Tips
</h2>
<div class="Unindented">
If you organize your code well, it would be very easy to implement partitioning. You simply assign different database operations to use different connection pools. If it’s by feature, then you can hardcode it for those features. If it’s sharding, then you add a switch before each operation telling it which connection pool to use.
</div>
<div class="Indented">
For example:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">def get_blogger_profile(user_id):
	connection = blogger_pool.get_connection()
	...
	connection.close()
​
def get_blog_post_and_comments(blog_post_id):
	shard_id = object.id % 3
	connection = blog_pools[shard_id].get_connection()
	...
	connection.close()
</code>
</div>
</div>
</div>
<div class="Indented">
Unfortunately, some programming practices make such an effective, clean organization difficult.
</div>
<div class="Indented">
Some developers prefer to use ORMs rather than access the database directly. Unfortunately, many ORMs do not easily allow for partitioning, either because they support only a single database connection pool, or because they don’t allow your objects to be easily shared between connections.
</div>
<div class="Indented">
For example, your logic might require you to retrieve an ‘‘object’’ from the database, and only then decide if you need to alter it or not. If you’re doing read/write partitioning, then you obviously want to read from the read partition. Some ORMs, though, have the object tied so strongly to an internal connection object that you can’t trivially read it from one connection and save it into another. You’d either have to read the object initially from the write partition, minimizing the usefulness of read/write partitioning, or re-read it from the write partition when you realize you need to alter it, causing unnecessary overhead. (Note that you’ll need to do this anyway if you need the write to happen in a transaction.)
</div>
<div class="Indented">
Object oriented design is also problematic in a more general sense. The first principle of object orientation is ‘‘encapsulation,’’ putting your code and data structure in one place: the class. This might make sense for business logic, but, for the purposes of refactoring your data backend for partitioning or other strategies, you really don’t want the data access code to be spread out among dozens of classes in your application. You want it all in one place, preferably even one source code file. It would let you plug in a whole new data backend strategy by replacing this source code file. For data-driven web development, you are better off not being too object oriented.
</div>
<div class="Indented">
Even more generally speaking, irganizing code together by mechanism, rather than by data ‘‘class,’’ will let you apply all kinds of refactorizations more easily, especially if you manage to decouple your application data structures from any library-specific data structures.
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-18"></a>Under the Hood
</h1>
<div class="Unindented">
Prudence brings together many open source libraries, some of which were designed specifically for Prudence.
</div>
<div class="Indented">
Consider this as Prudence’s ‘‘acknowledgments’’ page. Hundreds of people have worked on these libraries, and we’re grateful to all of them for sharing their hard work, for embracing open source licensing, and for adhering to design principles that allow reuse of their work in other projects, such as Prudence.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-105"></a>Restlet
</h2>
<div class="Unindented">
Prudence went through many transformations before aligning itself strongly with Restlet. First, we experimented with <a class="URL" href="https://facelets.dev.java.net/">Facelets</a>, but ended up giving up on <a class="URL" href="http://java.sun.com/javaee/javaserverfaces/">JSF</a>, its complex lifecycle, and on the promise of component-based web development in general. Then, we designed REST architectures using servlets and <a class="URL" href="http://threecrickets.com/succinct/">Succinct</a> templates, but found it awkward to force servlets into a REST architecture. Discovering <a class="URL" href="http://www.restlet.org/">Restlet</a> was a breath of fresh air.
</div>
<div class="Indented">
Restlet’s super-powers are three:
</div>
<ol>

<li>
Clean abstraction of HTTP requests, responses and headers over best-of-breed engines, such as <a class="URL" href="https://grizzly.dev.java.net/">Grizzly</a>, <a class="URL" href="http://jetty.codehaus.org/jetty/">Jetty</a> and <a class="URL" href="http://www.jboss.org/netty">Netty</a>. Automatically gain the scalable advantages of non-blocking I/O and even asynchronous request handling (which will be even better supported in Restlet 2.1). Restlet transparently handles conditional requests, content negotiation, and other complicated HTTP labor.
</li>
<li>
Powerful URI routing and manipulation. Expose your service to users and APIs with elegance and coherence. Make sure the URI reaches its destination, with support for virtual hosting, rewriting, templating, and other useful real-world features. Restlet is truly the Swiss army knife of URIs!
</li>
<li>
Straightforward data representation and consumption through a diverse set of extensions. Expose your data using any standard format, and even convert it on-the-fly. Easily parse data received from clients.
</li>
</ol>
<div class="Unindented">
Restlet is a great library, with a great ecosystem of extensions. In embracing it, though, we missed some of the advantages of having a servlet container: easy deployment and configuration, centralized logging, etc. We also missed having JSP at our fingertips to quickly push out dynamic HTML.
</div>
<div class="Indented">
Prudence is meant to fill in these gaps. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-106"></a>The JVM
</h2>
<div class="Unindented">
How wonderful that the best-performing, most robust and widely ported virtual machine is now open source? How wonderful that you can use it with JavaScript, Python, Ruby, Clojure, PHP and others languages?
</div>
<div class="Indented">
We strongly recommend the JVM for enterprise and scalable internet applications, even if you’re not particularly fond of Java-the-programming-language.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-107"></a>Jython, JRuby, Clojure, Rhino, Quercus, Groovy
</h2>
<div class="Unindented">
Prudence would hardly be as exciting if you had to use Java.
</div>
<div class="Indented">
These open source language engines have allowed us to extend the power of Prudence, REST and the JVM to languages outside of Java. Some of these engines are large, complex projects, and are in fact the biggest libraries included in Prudence. We strongly recommend you join in the communities surrounding the language engines corresponding to your favorite flavor of Prudence.
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-108"></a>Scripturian
</h2>
<div class="Unindented">
To make Prudence applications easy to deploy, they could not be traditional Java. The cycle of compilation and packaging is unnecessarily cumbersome. Though we could have implemented something like the on-the-fly Java compilation done in JSP, but we felt that, if that’s the route to go, many choices open up besides Java, and that these languages are more relevant to Prudence’s goals.
</div>
<div class="Indented">
There are many terrific JVM-based languages out there. Unfortunately, we found that integrating these languages into Prudence was anything but trivial. Each implementation had its own idea of what was acceptable support for embedding. We tried to standardize on <a class="URL" href="http://java.sun.com/developer/technicalArticles/J2SE/Desktop/scripting/">JSR-223 (the Java scripting standard)</a>, but found that adherence to the spec was inconsistent. We hacked and hacked and hacked. We even submitted patches to fix broken implementations of various languages. All in all, we probably spent more time on this than on any other aspect of Prudence.
</div>
<div class="Indented">
Since we think software other than Prudence can make use of our hard-won gains, we’ve abstracted and separated our language integration code as the <a class="URL" href="http://threecrickets.com/scripturian/">Scripturian</a> library. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-109"></a>Succinct
</h2>
<div class="Unindented">
<a class="URL" href="http://threecrickets.com/succinct/">Succinct</a> also started as a part of Prudence (one of its earliest components) that branched out into an independent library. We created it because we wanted straightforward, scalable templating built in to Prudence, and were unsatisfied by other open source offerings. We think you’ll like it. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-110"></a>Jygments
</h2>
<div class="Unindented">
Yet another Prudence side-project!
</div>
<div class="Indented">
For Prudence’s debug mode, we wanted good syntax highlighting for viewing source code. We found nothing adequate enough in the Java world, though we fell in love with Pygments. For a while, we ran Pygments in Prudence via Jython, but found it too heavy for this particular use case. Thus, <a class="URL" href="http://jygments.tigris.org/">Jygments</a> was born as a port of Pygments to Java. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-111"></a>H2
</h2>
<div class="Unindented">
We’re great fans of this lean and mean database engine! It has allowed us to distribute Prudence with a fully-functioning data-drive demo application, without any external dependencies. We’re proud to introduce <a class="URL" href="http://www.h2database.com/">H2</a>, through Prudence, to more people, and we believe you’ll find it fast enough, reliable enough, and flexible enough for many production environments. 
</div>
<h1 class="Section">
<a class="toc" name="toc-Section-19"></a>FAQ
</h1>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-112"></a>REST
</h2>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-35"></a>Why are plural URL forms for aggregate resources (/animal/cats/) preferred over singular forms (/animal/cat/)?
</h3>
<div class="Unindented">
You’ll see RESTful implementations that use either convention. The advantage of using the singular form is that you have less addresses, and what some people would call a more elegant scheme:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">/animal/cat/12 -&gt; Just one cat
/animal/cat/ -&gt; All cats
</code>
</div>
</div>
</div>
<div class="Indented">
Why add another URL when a single one is enough to do the work?  One reason is that you can help the client avoid potential errors. For example, the client probably uses a variable to hold the ID of the cat and then constructs the URL dynamically. But, what if the client forgets to check for null IDs? It might then construct a URL in the form ‘‘/animal/cat//’’ which would then successfully access <i>all</i> cats. This can cause unintended consequences and be difficult to debug. If, however, we used this scheme:
</div>
<div class="Indented">

<div class="float">

<div class="listing">
<code class="listing">/animal/cat/12 -&gt; Just one cat
/animal/cats/ -&gt; All cats
</code>
</div>
</div>
</div>
<div class="Indented">
...then the form ‘‘/animal/cat//’’ would route to our singular cat resource, which would indeed not find the cat and return the expected, debuggable 404 error. From this example, we can extract a good rule of thumb: clearly separate URLs at their base by usage, so that mistakes cannot happen. More addresses means more debuggability. 
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-113"></a>Languages
</h2>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-36"></a>Why mix languages? 
</h3>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-37"></a>What are ‘‘in-flow’’ scriptlets? 
</h3>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-38"></a>Can different languages share state? 
</h3>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-39"></a>Can languages call each other’s functions? 
</h3>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-114"></a>Concurrency
</h2>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-40"></a>Should I be worried? 
</h3>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-41"></a>How to make my code thread safe? 
</h3>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-115"></a>Performance
</h2>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-42"></a>Which Prudence flavor performs best? 
</h3>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-43"></a>How well does Prudence perform? How well does it scale?
</h3>
<div class="Unindented">
First, recognize that there are two common uses for the term ‘‘scale.’’ REST is often referred to as an inherently scalable architecture, but that has more to do with project management than technical performance. This difference is address in the <a class="URL" href="../rest/">Making the Case for REST</a>. 
</div>
<div class="Indented">
From the perspective of the ability to respond to user requests, there are three aspects to consider: 
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-72"></a>1. Serving HTTP
</div>
<div class="Unindented">
Prudence comes with <a class="URL" href="https://grizzly.dev.java.net/">Grizzly</a>, an HTTP server based on the JVM’s non-blocking I/O API. Grizzly handles concurrent HTTP requests very well, and serves static files at scales comparable to popular HTTP servers. See the <a class="URL" href="../guide/tutorial/">tutorial</a> for more information. 
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-73"></a>2. Generating HTML
</div>
<div class="Unindented">
Prudence supports two modes for generating HTML (and other textual formats), each with its own performance characteristics:
</div>
<div class="Subparagraph">
Caching mode:
</div>
<div class="Unindented">
First, the entire document is run, with its output sent into a buffer. This buffer is then cached, and <i>only then</i> sent to the client. This is the default mode and recommended for most documents. Scriptlets can be used to control the duration of the document’s individual cache. 
</div>
<div class="Subparagraph">
Streaming mode:
</div>
<div class="Unindented">
Output is sent to the client <i>while</i> the document runs. This is recommended for documents that need to output a very large amount of text, which might take a long time, or that might otherwise encounter slow-downs while running. In either case, you want the client to receive ongoing output. The output of the document is not cached.  Scriptlets can switch between modes according to changing circumstances. For example, to increase caching duration during heavy loads, to decrease it during periods where data changes often, or to stream in the case of an expected large output. See the <a class="URL" href="../guide/tutorial/">tutorial</a> for more information. 
</div>
<div class="Paragraph">
<a class="toc" name="toc-Paragraph-74"></a>3. Running code
</div>
<div class="Unindented">
There may be a delay when starting up a specific language engine in Prudence for the first time in an application, as it loads and initializes itself. Then, there may be a delay when accessing a dynamic web page or resource for the first time, or after it has been changed, as it might require compilation. Once it’s up and running, though, your code performs and scale very well---as well as you’ve written it. You need to understand concurrency and make sure you make good choices to handle coordination between threads accessing the same data. If all is good, your code will actually perform better throughout the life of the application. The JVM learns and adapts as it runs, and performance can improve the more the application is used.
</div>
<div class="Indented">
If you are performing CPU-intensive or time-sensitive tasks, then it’s best to profile these code segments precisely. Exact performance characteristics depend on the language and engine used. The <a class="URL" href="http://shootout.alioth.debian.org/">Bechmarks Game</a> can give you some comparisons of different language engines running high-computation programs. In any case, if you have a piece of intensive code that really needs to perform well, it’s probably best to write it in Java and access it from the your language. You can even write it in C or assembly, and have it linked to Java via JNI.   If you’re not doing intensive computation, then don’t worry too much about your language being ‘‘slow.’’ It’s been shown that for the vast majority of web applications, the performance of the web programming language is rarely the bottleneck. The deciding factors are the usually performance of the backend data-driving technologies and architectures.  
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-116"></a>Scalability
</h2>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-44"></a>Do you have any tips?
</h3>
<div class="Unindented">
Yes. :)
</div>
<h2 class="Subsection">
<a class="toc" name="toc-Subsection-117"></a>Licensing
</h2>
<div class="Unindented">
(The author is not a lawyer. This is not a legal advice, but a personal interpretation. The wording of the license itself superceds anything written here.)
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-45"></a>Does the LGPL mean I can’t use Prudence unless my product is open sourced?
</h3>
<div class="Unindented">
The GPL family of licenses restrict your ability to <i>redistribute</i> software, not to use it. You are free to use Prudence as you please within your organization, even if you’re using it to serve public web sites (though with no warranty nor an implicit guarantee of support from Three Crickets, the copyright holder).
</div>
<div class="Indented">
The GPL would thus only be an issue if you’re selling, or even giving away, a product that <i>would include</i> Prudence.
</div>
<div class="Indented">
Prudence uses the Lesser GPL, which has even less restrictions on redistribution than the regular GPL. As long as you do not alter Prudence in any way, you can include Prudence in any product, free or non-free. (Actually, Prudence uses version 3 of the Lesser GPL, which requires your product, even if it’s not free software, to at least not restrict users’ ownership of data via schemes such as DRM if you want to include Prudence in its distribution.)
</div>
<div class="Indented">
Even if your product does not qualify for including Prudence in it, you always have the option of distributing your product without Prudence, and instructing your customers to download and install Prudence on their own.
</div>
<div class="Indented">
Three Crickets, the original developers of Prudence, are not trying to force you to purchase it. Instead, they hope to encourage you 1) to pay Three Crickets for consultation, support and development services for Prudence, and 2) to release your own product as free software, thereby truly sharing your innovation with all of society.
</div>
<div class="Indented">
We understand that in some cases open sourcing your product is impossible. As a last resort, we offer you a commercial license. Please contact us for details.
</div>
<h3 class="Subsubsection">
<a class="toc" name="toc-Subsubsection-46"></a>Why the LGPL and not the GPL?
</h3>
<div class="Unindented">
The Lesser GPL used to be called the ‘‘Library GPL,’’ and was originally drafted for glibc. It represents a certain admission of defeat: there are so many alternatives to our library out there, that you might not consider using our library under GPL.
</div>
<div class="Indented">
In the case of Linux, the GPL has done a wonderful job in convincing vendors to open source their code in order to ship their products with Linux inside. It just doesn’t seem likely that they would do the same for Prudence.
</div>
<div class="Indented">
Note that the LGPL version 3 has a clause allowing you to ‘‘upgrade’’ Prudence to the full GPL for inclusion in your GPL-ed product. This is a terrific feature, and another reason to love this excellent license.
</div>

<hr>
<p>Copyright (C) 2010 Copyright 2009-2010 by Three Crickets LLC</p>
</div>
</body>
</html>

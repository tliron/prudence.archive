<?xml version="1.0"?>
<project name="Prudence" default="build">

	<!-- Configuration -->
	
	<property name="lib" value="../libraries" />
	<property name="common" value="../common" />
	<property name="test" value="../test" />
	<property name="java" value="../java" />
	<property name="java-src" value="${java}/com.threecrickets.prudence/src" />
	<property name="python" value="../python" />
	<property name="ruby" value="../ruby" />
	<property name="groovy" value="../groovy" />
	<property name="clojure" value="../clojure" />
	<property name="javascript" value="../javascript" />
	<property name="php" value="../php" />
	<property name="velocity" value="../velocity" />
	
	<property name="tmp" value="./tmp" />
	<property name="kitchensink-base" value="${javascript}" />
	<property name="dist-kitchensink" value="./kitchensink" />
	<property name="dist-standalone" value="./standalone" />
	<property name="dist-javascript" value="./javascript" />
	<property name="dist-python" value="./python" />

	<!-- Basic -->
	
	<target name="build" depends="kitchensink, standalone, javascript, python" description="Build distributions" />
	
	<target name="package" depends="package-kitchensink, package-standalone, package-javascript, package-python" description="Package distributions" />
	
	<target name="clean" description="Clean">
		<delete dir="${tmp}" />
		<delete dir="${dist-kitchensink}" />
		<delete dir="${dist-standalone}" />
		<delete dir="${dist-javascript}" />
		<delete dir="${dist-python}" />
	</target>
	
	<target name="rebuild" depends="clean, build" description="Clean and build distribution" />

	<!-- Essentials -->	

	<target name="compile" description="Compile Prudence code">
		<mkdir dir="${tmp}/classes" />
		<javac srcdir="${java-src}" destdir="${tmp}/classes" target="1.5">
			<classpath>
				<fileset dir="${lib}/scripturian/lib" />
				<fileset dir="${lib}/restlet/lib" />
			</classpath>
		</javac>
	</target>

	<target name="jar" depends="compile" description="Create Prudence jar">
		<mkdir dir="${tmp}/lib" />
		<jar destfile="${tmp}/lib/com.threecrickets.prudence.jar" basedir="${tmp}/classes" />
	</target>

	<target name="javadoc" description="Create Prudence API docs">
		<available file="${tmp}/javadoc" property="javadoc-present" />
		<antcall target="javadoc-unless" />
	</target>

	<target name="javadoc-unless" description="Create Prudence API docs" unless="javadoc-present">
		<javadoc access="protected" author="true" excludepackagenames="**.internal.*" destdir="${tmp}/javadoc" nodeprecated="false" nodeprecatedlist="false" noindex="false" nonavbar="false" notree="false" source="1.5" sourcepath="${java-src}" splitindex="true" use="true" version="true" windowtitle="Prudence 1.0" doctitle="Prudence 1.0" verbose="true">
			<link href="http://java.sun.com/j2se/1.5.0/docs/api/" />
			<link href="http://java.sun.com/javase/6/docs/api/" />
			<link href="http://www.threecrickets.com/scripturian/api/" />
			<link href="http://www.restlet.org/documentation/2.0/jse/api/" />
			<classpath>
				<fileset dir="${lib}/jsr223/lib" />
				<fileset dir="${lib}/scripturian/lib" />
				<fileset dir="${lib}/restlet/lib" />
			</classpath>
			<bottom>
				<![CDATA[<i>Copyright &#169; 2009 <a target="_top" href="http://www.threecrickets.com/">Three Crickets LLC</a>.</i>]]>
			</bottom>
		</javadoc>
	</target>

	<!-- Kitchensink -->

	<target name="kitchensink" depends="libraries-kitchensink, licenses-kitchensink, content-kitchensink" description="Fetch Prudence zip" />

	<target name="package-kitchensink" depends="kitchensink" description="Fetch Prudence zip">
		<zip destfile="${dist-kitchensink}/prudence-kitchensink.zip" level="9">
			<fileset dir="${dist-kitchensink}/content" excludes="lib/cachedir/, resources/jython/*.class" />
		</zip>
	</target>
	
	<target name="jar-kitchensink" depends="jar" description="Fetch Prudence jar">
		<mkdir dir="${dist-kitchensink}/content/lib" />
		<copy todir="${dist-kitchensink}/content/lib" file="${tmp}/lib/com.threecrickets.prudence.jar" />
	</target>

	<target name="javadoc-kitchensink" depends="javadoc" description="Fetch Prudence API docs">
		<copy todir="${dist-kitchensink}/content/applications/prudence-test/web/static/javadoc">
			<fileset dir="${tmp}/javadoc" />
		</copy>
	</target>

	<target name="libraries-kitchensink" depends="jar-kitchensink" description="Fetch libraries">
		<copy todir="${dist-kitchensink}/content/lib">
			<fileset dir="${lib}/clojure/lib" />
			<fileset dir="${lib}/grizzly/lib" />
			<fileset dir="${lib}/groovy/lib" />
			<fileset dir="${lib}/jepp/lib" />
			<fileset dir="${lib}/jruby/lib" />
			<fileset dir="${lib}/json/lib" />
			<fileset dir="${lib}/jsr223/lib" />
			<fileset dir="${lib}/jython/lib" />
			<fileset dir="${lib}/log4j/lib" />
			<fileset dir="${lib}/quercus/lib" />
			<fileset dir="${lib}/restlet/lib" />
			<fileset dir="${lib}/rhino/lib" />
			<fileset dir="${lib}/scripturian/lib" />
			<fileset dir="${lib}/slf4j/lib" />
			<fileset dir="${lib}/velocity/lib" />
			<fileset file="${lib}/versions.txt" />
		</copy>
	</target>
	
	<target name="licenses-kitchensink" description="Fetch licences">
		<copy todir="${dist-kitchensink}/content/licenses/clojure">
			<fileset dir="${lib}/clojure/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/grizzly">
			<fileset dir="${lib}/grizzly/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/groovy">
			<fileset dir="${lib}/groovy/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/jepp">
			<fileset dir="${lib}/jepp/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/jruby">
			<fileset dir="${lib}/jruby/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/json">
			<fileset dir="${lib}/json/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/jsr223">
			<fileset dir="${lib}/jsr223/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/jython">
			<fileset dir="${lib}/jython/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/log4j">
			<fileset dir="${lib}/log4j/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/quercus">
			<fileset dir="${lib}/quercus/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/restlet">
			<fileset dir="${lib}/restlet/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/rhino">
			<fileset dir="${lib}/rhino/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/scripturian">
			<fileset dir="${lib}/scripturian/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/slf4j">
			<fileset dir="${lib}/slf4j/license" />
		</copy>
		<copy todir="${dist-kitchensink}/content/licenses/velocity">
			<fileset dir="${lib}/velocity/license" />
		</copy>
	</target>

	<target name="content-kitchensink" depends="javadoc-kitchensink" description="Fetch content">
		<copy todir="${dist-kitchensink}/content">
			<fileset dir="${common}" excludes="log/" />
			<fileset dir="${test}" excludes="log/" />
		</copy>
		<copy todir="${dist-kitchensink}/content/component">
			<fileset dir="${kitchensink-base}/component" />
		</copy>
		<copy todir="${dist-kitchensink}/content/applications/prudence-admin">
			<fileset dir="${kitchensink-base}/applications/prudence-admin" />
		</copy>
		<copy todir="${dist-kitchensink}/content/applications/prudence-test">
			<fileset dir="${kitchensink-base}/applications/prudence-test" />
		</copy>
		<copy todir="${dist-kitchensink}/content/applications/prudence-test/web">
			<fileset dir="${python}/applications/prudence-test/web" />
			<fileset dir="${ruby}/applications/prudence-test/web" />
			<fileset dir="${groovy}/applications/prudence-test/web" />
			<fileset dir="${clojure}/applications/prudence-test/web" />
			<fileset dir="${javascript}/applications/prudence-test/web" />
			<fileset dir="${php}/applications/prudence-test/web" />
			<fileset dir="${velocity}/applications/prudence-test/web" />
		</copy>
		<copy todir="${dist-kitchensink}/content/applications/prudence-test/resources/test">
			<fileset dir="${python}/applications/prudence-test/resources/test" />
			<fileset dir="${ruby}/applications/prudence-test/resources/test" />
			<fileset dir="${groovy}/applications/prudence-test/resources/test" />
			<fileset dir="${clojure}/applications/prudence-test/resources/test" />
			<fileset dir="${javascript}/applications/prudence-test/resources/test" />
		</copy>
		<chmod file="${dist-kitchensink}/content/run.sh" perm="ugo+rx"/>
	</target>

	<!-- Standalone -->
	
	<target name="standalone" depends="src-standalone, jar-standalone, content-standalone" description="Fetch Prudence zip" />

	<target name="package-standalone" depends="standalone" description="Fetch Prudence zip">
		<zip destfile="${dist-standalone}/prudence-standalone.zip" level="9">
			<fileset dir="${dist-standalone}/content" />
		</zip>
	</target>

	<target name="jar-standalone" depends="jar" description="Fetch Prudence jar">
		<copy todir="${dist-standalone}/content/lib" file="${tmp}/lib/com.threecrickets.prudence.jar" />
	</target>

	<target name="src-standalone" description="Fetch Prudence source">
		<copy todir="${dist-standalone}/content/src">
			<fileset dir="${java-src}" />
		</copy>
	</target>
	
	<target name="javadoc-standalone" depends="javadoc" description="Fetch Prudence API docs">
		<copy todir="${dist-standalone}/content/javadoc">
			<fileset dir="${tmp}/javadoc" />
		</copy>
	</target>

	<target name="content-standalone" depends="javadoc-standalone" description="Fetch content">
		<copy todir="${dist-standalone}/content">
			<fileset dir="${common}" excludes="log/, conf/, web/, run.*" />
		</copy>
	</target>

	<!-- JavaScript -->

	<target name="javascript" depends="libraries-javascript, licenses-javascript, content-javascript" description="Fetch Prudence zip" />
	
	<target name="package-javascript" depends="javascript" description="Fetch Prudence zip">
		<zip destfile="${dist-javascript}/prudence-javascript.zip" level="9">
			<fileset dir="${dist-javascript}/content" />
		</zip>
	</target>
	
	<target name="jar-javascript" depends="jar" description="Fetch Prudence jar">
		<copy todir="${dist-javascript}/content/lib" file="${tmp}/lib/com.threecrickets.prudence.jar" />
	</target>

	<target name="libraries-javascript" depends="jar-javascript" description="Fetch libraries">
		<copy todir="${dist-javascript}/content/lib">
			<fileset dir="${lib}/grizzly/lib" />
			<fileset dir="${lib}/json/lib" />
			<fileset dir="${lib}/jsr223/lib" />
			<fileset dir="${lib}/log4j/lib" />
			<fileset dir="${lib}/restlet/lib" />
			<fileset dir="${lib}/rhino/lib" />
			<fileset dir="${lib}/scripturian/lib" />
			<fileset dir="${lib}/slf4j/lib" />
			<fileset dir="${lib}/velocity/lib" />
			<fileset file="${lib}/versions.txt" />
		</copy>
	</target>

	<target name="licenses-javascript" description="Fetch licences">
		<copy todir="${dist-javascript}/content/licenses/grizzly">
			<fileset dir="${lib}/grizzly/license" />
		</copy>
		<copy todir="${dist-javascript}/content/licenses/json">
			<fileset dir="${lib}/json/license" />
		</copy>
		<copy todir="${dist-javascript}/content/licenses/jsr223">
			<fileset dir="${lib}/jsr223/license" />
		</copy>
		<copy todir="${dist-javascript}/content/licenses/log4j">
			<fileset dir="${lib}/log4j/license" />
		</copy>
		<copy todir="${dist-javascript}/content/licenses/restlet">
			<fileset dir="${lib}/restlet/license" />
		</copy>
		<copy todir="${dist-javascript}/content/licenses/rhino">
			<fileset dir="${lib}/rhino/license" />
		</copy>
		<copy todir="${dist-javascript}/content/licenses/scripturian">
			<fileset dir="${lib}/scripturian/license" />
		</copy>
		<copy todir="${dist-javascript}/content/licenses/slf4j">
			<fileset dir="${lib}/slf4j/license" />
		</copy>
		<copy todir="${dist-javascript}/content/licenses/velocity">
			<fileset dir="${lib}/velocity/license" />
		</copy>
	</target>

	<target name="javadoc-javascript" depends="javadoc" description="Fetch Prudence API docs">
		<copy todir="${dist-javascript}/content/applications/prudence-test/web/static/javadoc">
			<fileset dir="${tmp}/javadoc" />
		</copy>
	</target>

	<target name="content-javascript" depends="javadoc-javascript" description="Fetch content">
		<copy todir="${dist-javascript}/content">
			<fileset dir="${common}" excludes="log/, run.*" />
			<fileset dir="${javascript}" />
		</copy>
		<chmod file="${dist-javascript}/content/run.sh" perm="ugo+rx"/>
	</target>

	<!-- Python -->

	<target name="python" depends="libraries-python, licenses-python, content-python" description="Fetch Prudence zip" />
	
	<target name="package-python" depends="python" description="Fetch Prudence zip">
		<zip destfile="${dist-python}/prudence-python.zip" level="9">
			<fileset dir="${dist-python}/content" excludes="lib/cachedir/, resources/jython/*.class" />
		</zip>
	</target>
	
	<target name="jar-python" depends="jar" description="Fetch Prudence jar">
		<copy todir="${dist-python}/content/lib" file="${tmp}/lib/com.threecrickets.prudence.jar" />
	</target>

	<target name="libraries-python" depends="jar-python" description="Fetch libraries">
		<copy todir="${dist-python}/content/lib">
			<fileset dir="${lib}/grizzly/lib" />
			<fileset dir="${lib}/jepp/lib" />
			<fileset dir="${lib}/json/lib" />
			<fileset dir="${lib}/jsr223/lib" />
			<fileset dir="${lib}/jython/lib" />
			<fileset dir="${lib}/log4j/lib" />
			<fileset dir="${lib}/restlet/lib" />
			<fileset dir="${lib}/scripturian/lib" />
			<fileset dir="${lib}/slf4j/lib" />
			<fileset dir="${lib}/velocity/lib" />
			<fileset file="${lib}/versions.txt" />
		</copy>
	</target>
	
	<target name="licenses-python" description="Fetch licences for Python">
		<copy todir="${dist-python}/content/licenses/grizzly">
			<fileset dir="${lib}/grizzly/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/jepp">
			<fileset dir="${lib}/jepp/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/json">
			<fileset dir="${lib}/json/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/jsr223">
			<fileset dir="${lib}/jsr223/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/jython">
			<fileset dir="${lib}/jython/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/log4j">
			<fileset dir="${lib}/log4j/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/restlet">
			<fileset dir="${lib}/restlet/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/scripturian">
			<fileset dir="${lib}/scripturian/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/slf4j">
			<fileset dir="${lib}/slf4j/license" />
		</copy>
		<copy todir="${dist-python}/content/licenses/velocity">
			<fileset dir="${lib}/velocity/license" />
		</copy>
	</target>

	<target name="javadoc-python" depends="javadoc" description="Fetch Prudence API docs">
		<copy todir="${dist-python}/content/applications/prudence-test/web/static/javadoc">
			<fileset dir="${tmp}/javadoc" />
		</copy>
	</target>

	<target name="content-python" depends="javadoc-python" description="Fetch content">
		<copy todir="${dist-python}/content">
			<fileset dir="${common}" excludes="log/, run.*" />
			<fileset dir="${python}" />
		</copy>
		<chmod file="${dist-python}/content/run.sh" perm="ugo+rx"/>
	</target>
	
</project>
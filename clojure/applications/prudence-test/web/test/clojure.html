<html>
<head>
	<title>Clojure Scriptlets Demo</title>
	<link rel="stylesheet" type="text/css" href="../static/prudence.css" />
</head>
<body>
<table width="100%"><tr valign="top"><td>
<%Clojure

;
; Accessing the request
;

(def form (.. document getContainer getRequest getResourceRef getQueryAsForm))

;
; Stream this script
;

(if (= (.getFirstValue form "stream") "true") 
	(if (.. document getContainer stream)
		(throw nil)
	)
)

;
; Calling Java
;

(.setCacheDuration document 5000)
(print "This page was dynamically generated at " (System/currentTimeMillis))

;
; Including a document
;
; This is identical to:
;
;   (.. document getContainer (includeDocument "path"))
;

%>
<%& "test/clojure-fragment" %>
<%

;
; An example of a function
;

(defn print-factory [f] (let [factory (bean f)]
%>
<p>
	<i>Engine:</i> <%= (:engineName factory) %> version <%= (:engineVersion factory) %><br />
	<i>Language:</i> <%= (:languageName factory) %> version <%= (:languageVersion factory) %><br />
	<i>Names:</i> 
<%
	(def names (:names factory))
	(doseq [name (butlast names)]
		(print name)
		(print ", ")
	)
	(print (last names))
%>
</p>
<%
))
%>
<h3>Script engine used:</h3>
<%
(print-factory (.. document getEngine getFactory))
%>
<h3>Available script engines:</h3>
<%
(def factories (.. document getEngineManager getEngineFactories))
(doseq [factory factories]
	(print-factory factory)
)
%>
</td><td>
<h3>The "id" attribute in the URL query is:</h3>
<p><%= (or (.getFirstValue form "id") "") %></p>
<h3>A few tests:</h3>
<%
(doseq [i (range 10)]
	(do
%>
A multiple of three: 
<%
	(print-triple i)
%>
<br />
<%
	)
)
%>
</td></tr></table>
</body>
<html>
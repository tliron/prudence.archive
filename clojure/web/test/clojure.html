<html>
<head>
	<title>Clojure Scriptlets Demo</title>
	<link rel="stylesheet" type="text/css" href="../static/prudence.css" />
</head>
<body>
<table width="100%"><tr valign="top"><td>
<%Clojure

;
; Accessing the request
;

(def form (.getQueryAsForm (.getResourceRef (.getRequest (.getContainer document)))))

;
; Stream this script
;

(if (= (.getFirstValue form "stream") "true") 
	(if (.stream (.getContainer document))
		(throw nil)
	)
)

;
; Calling Java
;

(.setCacheDuration document 5000)
(print "This page was dynamically generated at " (System/currentTimeMillis))

;
; Including a document
;
; This is identical to:
;
;   (.includeDocument (.getContainer document) "path")
;

%>
<%& (str (.get (.getMeta document) "prudenceDemoBasePath") "test/clojure-fragment") %>
<%

;
; An example of a function
;

(defn printFactory [factory]
%>
<p>
	<i>Engine:</i> <%= (.getEngineName factory) %> version <%= (.getEngineVersion factory) %><br />
	<i>Language:</i> <%= (.getLanguageName factory) %> version <%= (.getLanguageVersion factory) %><br />
	<i>Names:</i> 
<%
	(def names (.getNames factory))
	(doseq [name (butlast names)]
		(print name)
		(print ", ")
	)
	(print (last names))
%>
</p>
<%
)
%>
<h3>Script engine used:</h3>
<%
(printFactory (.getFactory (.getEngine document)))
%>
<h3>Available script engines:</h3>
<%
(def factories (.getEngineFactories (.getEngineManager document)))
(doseq [factory factories]
	(printFactory factory)
)
%>
</td><td>
<h3>The "id" attribute in the URL query is:</h3>
<p><%= (or (.getFirstValue form "id") "") %></p>
<h3>A few tests:</h3>
<%
(doseq [i (range 10)]
	(do
%>
A multiple of three: 
<%
	(printTriple i)
%>
<br />
<%
	)
)
%>
</td></tr></table>
</body>
<html>